<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PAPO'S of the World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    type="text/css"
    href="https://www.paypalobjects.com/webstatic/en_US/developer/docs/css/cardfields.css"
  />
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDeL0dHVQnigck1fFNT97eMlXlC1W2BEgM&libraries=geometry"></script>
  <!-- PayPal Expanded Checkout SDK (with card fields, buttons, and 3DS) -->
  <!-- Start with minimal URL to debug 400 error -->
  <script
    src="https://www.paypal.com/sdk/js?client-id=AXAzi9txkuDcg3jPwu8ooaMCG0PWjAy01RAq9_BPznGD4hIdLTqbUJC1djj95cb8m8OVFmTymJaIqc73&amp;currency=USD&amp;components=buttons,card-fields"
    onload="window.paypalSDKLoaded = true; console.log('PayPal SDK loaded successfully');"
    onerror="console.error('Failed to load PayPal SDK');"
  ></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    html, body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #1ea4d4;
      color: #3e2b18;
      overflow: hidden;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
    }

    .page {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      position: fixed;
      top: 0;
      left: 0;
      overflow: hidden;
    }

    /* Navigation Bar */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      background: linear-gradient(to bottom, #b8966a, #a0825a, #8b6f47);
      border-bottom: 3px solid #5a4a3a;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 15;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .navbar-brand {
      font-size: 20px;
      font-weight: 800;
      color: #f9e0b5;
      text-shadow: 2px 2px 0 #5a4a3a;
      letter-spacing: 0.05em;
      text-decoration: none;
    }

    .navbar-nav {
      display: flex;
      align-items: center;
      gap: 24px;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .navbar-nav a {
      color: #f9e0b5;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.05em;
      text-shadow: 1px 1px 0 #5a4a3a;
      transition: color 0.2s ease;
      padding: 6px 12px;
      border-radius: 4px;
    }

    .navbar-nav a:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .navbar-cart {
      width: 24px;
      height: 24px;
      cursor: pointer;
      fill: #f9e0b5;
      stroke: #5a4a3a;
      stroke-width: 1.5;
      transition: fill 0.2s ease;
    }

    .navbar-cart:hover {
      fill: #fff;
    }

    @media (max-width: 768px) {
      .navbar {
        padding: 10px 16px;
      }
      .navbar-brand {
        font-size: 16px;
      }
      .navbar-nav {
        gap: 12px;
      }
      .navbar-nav a {
        font-size: 12px;
        padding: 4px 8px;
      }
    }

    /* Header / sign */
    .sign-container {
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      padding: 16px 0 0 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 10;
      pointer-events: none;
    }
    
    .sign-container > * {
      pointer-events: auto;
    }

    .sign-hook {
      width: 60px;
      height: 8px;
      background: #4a3a2a;
      border-radius: 4px;
      position: relative;
      margin-bottom: 2px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      animation: hookAppear 0.5s ease-out forwards;
      opacity: 0;
    }

    @keyframes hookAppear {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .sign-chains {
      display: flex;
      gap: 300px;
      position: relative;
      z-index: 1;
      animation: chainsFall 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
      opacity: 0;
      transform: translateY(-200px);
    }

    @media (max-width: 768px) {
      .sign-chains {
        gap: 200px;
      }
    }

    @keyframes chainsFall {
      0% {
        opacity: 0;
        transform: translateY(-200px);
      }
      60% {
        opacity: 1;
        transform: translateY(10px);
      }
      80% {
        transform: translateY(-5px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chain-link {
      width: 2px;
      height: 40px;
      background: linear-gradient(to bottom, #6b5a4a, #4a3a2a, #3a2a1a);
      position: relative;
      animation: chainOscillate 5s ease-out 1.2s forwards;
      transform-origin: top center;
    }

    .chain-link::before,
    .chain-link::after {
      content: '';
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #4a3a2a;
      left: 50%;
      transform: translateX(-50%);
    }

    .chain-link::before {
      top: -4px;
    }

    .chain-link::after {
      bottom: -4px;
    }

    .chain-link:nth-child(2) {
      animation-delay: 0.1s;
    }

    @keyframes chainSwing {
      0%, 100% {
        transform: rotate(0deg);
      }
      25% {
        transform: rotate(1.5deg);
      }
      75% {
        transform: rotate(-1.5deg);
      }
    }

    @keyframes chainOscillate {
      /* Physics-based chain oscillation - follows sign movement with slight delay */
      /* Chains swing in phase with the sign but with smaller amplitude */
      0% {
        transform: rotate(0deg);
      }
      2% {
        transform: rotate(0.3deg);
      }
      4% {
        transform: rotate(0.5deg);
      }
      6% {
        transform: rotate(0.6deg);
      }
      8% {
        transform: rotate(0.5deg);
      }
      10% {
        transform: rotate(0.3deg);
      }
      12% {
        transform: rotate(0deg);
      }
      14% {
        transform: rotate(-0.3deg);
      }
      16% {
        transform: rotate(-0.5deg);
      }
      18% {
        transform: rotate(-0.6deg);
      }
      20% {
        transform: rotate(-0.5deg);
      }
      22% {
        transform: rotate(-0.3deg);
      }
      24% {
        transform: rotate(0deg);
      }
      26% {
        transform: rotate(0.25deg);
      }
      28% {
        transform: rotate(0.4deg);
      }
      30% {
        transform: rotate(0.45deg);
      }
      32% {
        transform: rotate(0.35deg);
      }
      34% {
        transform: rotate(0.2deg);
      }
      36% {
        transform: rotate(0deg);
      }
      38% {
        transform: rotate(-0.2deg);
      }
      40% {
        transform: rotate(-0.35deg);
      }
      42% {
        transform: rotate(-0.45deg);
      }
      44% {
        transform: rotate(-0.4deg);
      }
      46% {
        transform: rotate(-0.25deg);
      }
      48% {
        transform: rotate(0deg);
      }
      50% {
        transform: rotate(0.2deg);
      }
      52% {
        transform: rotate(0.3deg);
      }
      54% {
        transform: rotate(0.32deg);
      }
      56% {
        transform: rotate(0.25deg);
      }
      58% {
        transform: rotate(0.15deg);
      }
      60% {
        transform: rotate(0deg);
      }
      62% {
        transform: rotate(-0.15deg);
      }
      64% {
        transform: rotate(-0.25deg);
      }
      66% {
        transform: rotate(-0.32deg);
      }
      68% {
        transform: rotate(-0.3deg);
      }
      70% {
        transform: rotate(-0.2deg);
      }
      72% {
        transform: rotate(0deg);
      }
      74% {
        transform: rotate(0.1deg);
      }
      76% {
        transform: rotate(0.18deg);
      }
      78% {
        transform: rotate(0.2deg);
      }
      80% {
        transform: rotate(0.15deg);
      }
      82% {
        transform: rotate(0.08deg);
      }
      84% {
        transform: rotate(0deg);
      }
      86% {
        transform: rotate(-0.08deg);
      }
      88% {
        transform: rotate(-0.15deg);
      }
      90% {
        transform: rotate(-0.2deg);
      }
      92% {
        transform: rotate(-0.18deg);
      }
      94% {
        transform: rotate(-0.1deg);
      }
      96% {
        transform: rotate(0deg);
      }
      98% {
        transform: rotate(0.05deg);
      }
      100% {
        transform: rotate(0deg);
      }
    }

    .sign-planks {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
      transform-origin: top center;
      animation: signFall 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards,
                 signOscillate 5s ease-out 1.2s forwards;
      opacity: 0;
      transform: translateY(-200px) rotateX(90deg);
    }

    .sign-top-plank {
      position: relative;
      padding: 24px 50px 20px;
      background: linear-gradient(to bottom, #6b4e37, #5a3e2a, #4a2e1a);
      border: 4px solid #3a2515;
      text-align: center;
      box-shadow: 
        inset 0 2px 4px rgba(255, 255, 255, 0.1),
        inset 0 -2px 4px rgba(0, 0, 0, 0.5),
        0 8px 16px rgba(0, 0, 0, 0.6);
      min-width: 400px;
      z-index: 2;
    }

    .sign-bottom-plank {
      position: relative;
      padding: 12px 30px;
      background: linear-gradient(to bottom, #5a3e2a, #4a2e1a, #3a2515);
      border: 2px solid #3a2515;
      border-top: none;
      box-shadow: 
        inset 0 2px 4px rgba(255, 255, 255, 0.1),
        inset 0 -2px 4px rgba(0, 0, 0, 0.5),
        0 6px 12px rgba(0, 0, 0, 0.5);
      min-width: 400px;
      margin-top: -2px;
      z-index: 1;
    }

    .banner {
      position: relative;
      padding: 20px 40px 24px;
      background: linear-gradient(to bottom, #d4a574, #b8966a, #a0825a);
      border: 4px solid #5a4a3a;
      text-align: center;
      box-shadow: 
        inset 0 2px 4px rgba(255, 255, 255, 0.2),
        inset 0 -2px 4px rgba(0, 0, 0, 0.3),
        0 8px 16px rgba(0, 0, 0, 0.4);
      transform-origin: top center;
      animation: signFall 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards,
                 signJiggle 0.5s ease-in-out 1.2s infinite;
      opacity: 0;
      transform: translateY(-200px) rotateX(90deg);
    }

    @keyframes signFall {
      0% {
        opacity: 0;
        transform: translateY(-200px) rotateX(90deg);
      }
      60% {
        opacity: 1;
        transform: translateY(10px) rotateX(0deg);
      }
      80% {
        transform: translateY(-5px) rotateX(0deg);
      }
      100% {
        opacity: 1;
        transform: translateY(0) rotateX(0deg);
      }
    }

    @keyframes signJiggle {
      0%, 100% {
        transform: translateY(0) rotate(0deg);
      }
      25% {
        transform: translateY(-2px) rotate(0.5deg);
      }
      50% {
        transform: translateY(0) rotate(0deg);
      }
      75% {
        transform: translateY(-1px) rotate(-0.5deg);
      }
    }

    @keyframes signOscillate {
      /* Physics-based damped pendulum oscillation */
      /* Sign swings like a real pendulum with exponential decay */
      /* Primary movement is rotation around chain attachment point */
      /* Period ~1.4s, damping time constant ~4s */
      0% {
        transform: rotate(0deg);
      }
      2.5% {
        transform: rotate(0.8deg);
      }
      5% {
        transform: rotate(1.2deg);
      }
      7.5% {
        transform: rotate(1.3deg);
      }
      10% {
        transform: rotate(1.1deg);
      }
      12.5% {
        transform: rotate(0.6deg);
      }
      15% {
        transform: rotate(0deg);
      }
      17.5% {
        transform: rotate(-0.6deg);
      }
      20% {
        transform: rotate(-1.1deg);
      }
      22.5% {
        transform: rotate(-1.3deg);
      }
      25% {
        transform: rotate(-1.2deg);
      }
      27.5% {
        transform: rotate(-0.8deg);
      }
      30% {
        transform: rotate(0deg);
      }
      32.5% {
        transform: rotate(0.5deg);
      }
      35% {
        transform: rotate(0.9deg);
      }
      37.5% {
        transform: rotate(1deg);
      }
      40% {
        transform: rotate(0.85deg);
      }
      42.5% {
        transform: rotate(0.5deg);
      }
      45% {
        transform: rotate(0deg);
      }
      47.5% {
        transform: rotate(-0.5deg);
      }
      50% {
        transform: rotate(-0.85deg);
      }
      52.5% {
        transform: rotate(-1deg);
      }
      55% {
        transform: rotate(-0.9deg);
      }
      57.5% {
        transform: rotate(-0.5deg);
      }
      60% {
        transform: rotate(0deg);
      }
      62.5% {
        transform: rotate(0.4deg);
      }
      65% {
        transform: rotate(0.7deg);
      }
      67.5% {
        transform: rotate(0.75deg);
      }
      70% {
        transform: rotate(0.6deg);
      }
      72.5% {
        transform: rotate(0.35deg);
      }
      75% {
        transform: rotate(0deg);
      }
      77.5% {
        transform: rotate(-0.35deg);
      }
      80% {
        transform: rotate(-0.6deg);
      }
      82.5% {
        transform: rotate(-0.75deg);
      }
      85% {
        transform: rotate(-0.7deg);
      }
      87.5% {
        transform: rotate(-0.4deg);
      }
      90% {
        transform: rotate(0deg);
      }
      92.5% {
        transform: rotate(0.25deg);
      }
      95% {
        transform: rotate(0.3deg);
      }
      97.5% {
        transform: rotate(0.15deg);
      }
      100% {
        transform: rotate(0deg);
      }
    }

    /* Wood plank texture effect */
    .sign-top-plank::before,
    .sign-bottom-plank::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.08) 2px,
          rgba(0, 0, 0, 0.08) 4px
        ),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 20px,
          rgba(0, 0, 0, 0.05) 20px,
          rgba(0, 0, 0, 0.05) 22px
        );
      pointer-events: none;
      opacity: 0.6;
    }

    .banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.05) 2px,
          rgba(0, 0, 0, 0.05) 4px
        ),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 20px,
          rgba(0, 0, 0, 0.03) 20px,
          rgba(0, 0, 0, 0.03) 22px
        );
      pointer-events: none;
      border-radius: inherit;
    }

    .sign-title {
      font-size: clamp(36px, 5vw, 48px);
      letter-spacing: 0.08em;
      font-weight: 900;
      color: #ffffff;
      font-family: Georgia, serif;
      text-shadow: 
        3px 3px 0 #2a1a0a,
        -1px -1px 0 #2a1a0a,
        1px -1px 0 #2a1a0a,
        -1px 1px 0 #2a1a0a;
      margin-bottom: 12px;
      position: relative;
    }

    .sign-slogan {
      font-size: clamp(14px, 2vw, 18px);
      letter-spacing: 0.05em;
      color: #ffffff;
      font-weight: 600;
      font-style: italic;
      position: relative;
    }

    .sign-slogan .desnac-text {
      color: #ffd700;
      font-weight: 700;
      font-style: italic;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .ai-search-container {
      display: flex;
      align-items: center;
      background: #ffffff;
      border: 2px solid #3a2515;
      border-radius: 6px;
      padding: 10px 16px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .ai-search-icon {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      color: #3a2515;
      flex-shrink: 0;
    }

    .ai-search-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 16px;
      color: #3a2515;
      background: transparent;
      font-weight: 600;
    }

    .ai-search-input::placeholder {
      color: #666;
      font-weight: 500;
    }

    .ai-search-input:focus {
      outline: none;
    }

    /* AI Response Panel */
    .ai-response-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(600px, 90vw);
      max-height: 70vh;
      background: #f4e5c1;
      border: 4px solid #8b6f47;
      border-radius: 12px;
      box-shadow: 0 14px 0 rgba(0, 0, 0, 0.4);
      z-index: 100;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .ai-response-panel.visible {
      display: flex;
    }

    .ai-response-header {
      background: linear-gradient(to bottom, #b8966a, #a0825a);
      padding: 16px 20px;
      border-bottom: 3px solid #8b6f47;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ai-response-title {
      font-size: 20px;
      font-weight: 800;
      color: #f9e0b5;
      text-shadow: 2px 2px 0 #5a4a3a;
      letter-spacing: 0.05em;
    }

    .ai-response-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #f9e0b5;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
    }

    .ai-response-close:hover {
      transform: scale(1.1);
    }

    .ai-response-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .ai-response-content {
      color: #3e2b18;
      font-size: 16px;
      line-height: 1.6;
    }

    .ai-response-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #8b6f47;
      font-size: 18px;
    }

    .ai-response-loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .ai-response-error {
      color: #8b1a1a;
      background: #ffe5e5;
      padding: 16px;
      border-radius: 8px;
      border: 2px solid #cc6b6b;
      margin-top: 12px;
    }

    .chain-link-bottom {
      width: 2px;
      height: 20px;
      background: linear-gradient(to bottom, #5a4a3a, #3a2a1a);
      position: relative;
      animation: chainOscillate 5s ease-out 1.2s forwards;
      transform-origin: top center;
    }

    .chain-link-bottom::before,
    .chain-link-bottom::after {
      content: '';
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #4a3a2a;
      left: 50%;
      transform: translateX(-50%);
    }

    .chain-link-bottom::before {
      top: -4px;
    }

    .chain-link-bottom::after {
      bottom: -4px;
    }

    /* World map container */

    .world-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      overflow: hidden;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .world-wrapper .token {
      position: absolute;
    }

    .world-map {
      width: 100% !important;
      height: 100% !important;
      border: none;
      display: block;
      margin: 0;
      padding: 0;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* Ensure Google Maps fills container */
    .world-map > div,
    .world-map > div > div {
      width: 100% !important;
      height: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    /* Remove any default Google Maps margins */
    .gm-style,
    .gm-style-cc,
    .gm-style-mtc {
      margin: 0 !important;
      padding: 0 !important;
    }

    /* Flavor tokens */

    .token {
      position: fixed;
      width: 90px;
      height: 90px;
      border-radius: 999px;
      border: 4px solid #f5f0e4;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      z-index: 5;
      pointer-events: auto;
    }

    .token:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 9px 0 rgba(0, 0, 0, 0.25);
    }

    .token::after {
      content: attr(data-label);
      position: absolute;
      left: 50%;
      bottom: -1.4rem;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 11px;
      font-weight: 600;
      color: #fef5dd;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
    }

    /* Rough positions (tweak as needed) */
    .token-granola { 
      /* San Jose, CA: 37.3382°N, 121.8863°W */
      left: 16.5%; 
      top: 41.5%; 
    background-image: url("images/token-granola.png");
    }
    .token-jamaican { 
      background-image: url("images/token-jamaican.png") !important;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      background-color: transparent;
    }
    .token-cafe { 
      left: 34%; 
      top: 72%; 
      background-image: url("images/token-coffee.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    .token-zaatar { 
      left: 52%; 
      top: 55%; 
    background-image: url("images/token-zaatar.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    .token-pumpkin { 
      background-image: url("images/token-pumpkin.png") !important;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      background-color: transparent;
    }
    .token-orange { 
      background-image: url("images/token-orange.png") !important;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      background-color: transparent;
    }
    .token-pearlz { 
      background-image: url("images/pearlz.png") !important;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      background-color: transparent;
    }
    .token-tomatoeouy { 
      background-image: url("images/token-tomatoeouy.png") !important;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      background-color: transparent;
    }
    .token-evergreenglow { 
      background-image: url("images/evergreenglow.png") !important;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      background-color: transparent;
    }
    .token-totallynutz { 
      background-image: url("images/token-totallynutz.png") !important;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      background-color: transparent;
    }
    .token-barbecue { 
      background-image: url("images/token-barbecue.png") !important;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      background-color: transparent;
    }
    .token-bagel { 
      background-image: url("images/token-bagel.png") !important;
      background-size: cover !important;
      background-position: center !important;
      background-repeat: no-repeat !important;
      background-color: transparent;
    }

    /* Just to show something while you wire real artwork in */
    .token-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      text-align: center;
      padding: 6px;
      background: radial-gradient(circle at 30% 30%, #ffe5a8, #cc8b3b);
      color: #4d3114;
    }

    /* Modal */

    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal.visible {
      opacity: 1;
      pointer-events: auto;
    }

    /* Why deSnac Modal */
    .desnac-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .desnac-modal.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .desnac-modal-content {
      position: relative;
      width: min(1200px, 95vw);
      max-height: 90vh;
      background: #f4e5c1;
      border-radius: 12px;
      box-shadow: 0 14px 0 rgba(0, 0, 0, 0.4);
      overflow-y: auto;
      padding: 30px 40px;
      z-index: 10;
      border: 4px solid #8b6f47;
    }

    .desnac-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #8b6f47;
    }

    .desnac-header h1 {
      font-size: clamp(32px, 4vw, 42px);
      color: #5a4a3a;
      font-weight: 900;
      letter-spacing: 0.05em;
      margin-bottom: 10px;
    }

    .desnac-header .subtitle {
      font-size: 18px;
      color: #8b6f47;
      font-weight: 600;
      font-style: italic;
    }

    .desnac-section {
      margin-bottom: 40px;
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      border: 2px solid #e0d5c0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .desnac-section h2 {
      font-size: 24px;
      color: #5a4a3a;
      font-weight: 800;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .desnac-section h3 {
      font-size: 20px;
      color: #8b6f47;
      font-weight: 700;
      margin-top: 20px;
      margin-bottom: 12px;
    }

    .desnac-section p {
      font-size: 16px;
      line-height: 1.7;
      color: #3e2b18;
      margin-bottom: 12px;
    }

    .desnac-section ul {
      list-style: none;
      padding: 0;
      margin: 16px 0;
    }

    .desnac-section li {
      font-size: 15px;
      line-height: 1.8;
      color: #3e2b18;
      margin-bottom: 10px;
      padding-left: 28px;
      position: relative;
    }

    .desnac-section li::before {
      content: '✓';
      position: absolute;
      left: 0;
      color: #3f8d3a;
      font-weight: bold;
      font-size: 18px;
    }

    .desnac-columns {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-top: 30px;
    }

    .desnac-column {
      background: #f9f7f2;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #e0d5c0;
    }

    .desnac-column h3 {
      color: #5a4a3a;
      font-size: 20px;
      margin-bottom: 12px;
      border-bottom: 2px solid #8b6f47;
      padding-bottom: 8px;
    }

    .triple-satiety-diagram {
      background: linear-gradient(135deg, #f4e5c1, #e4c57b);
      padding: 30px;
      border-radius: 12px;
      border: 3px solid #8b6f47;
      text-align: center;
      margin-top: 30px;
    }

    .triple-satiety-diagram h2 {
      font-size: 32px;
      color: #5a4a3a;
      font-weight: 900;
      margin-bottom: 20px;
    }

    .triple-satiety-triangle {
      position: relative;
      width: 100%;
      max-width: 400px;
      height: 350px;
      margin: 30px auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .triangle-shape {
      width: 0;
      height: 0;
      border-left: 200px solid transparent;
      border-right: 200px solid transparent;
      border-bottom: 350px solid rgba(139, 111, 71, 0.15);
      position: relative;
      margin: 0 auto;
    }

    .triangle-label {
      position: absolute;
      font-weight: 700;
      color: #5a4a3a;
      font-size: 15px;
      text-align: center;
      line-height: 1.3;
      background: rgba(244, 229, 193, 0.9);
      padding: 8px 12px;
      border-radius: 6px;
      border: 2px solid #8b6f47;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .triangle-label.top {
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
    }

    .triangle-label.bottom-left {
      bottom: 30px;
      left: 10px;
    }

    .triangle-label.bottom-right {
      bottom: 30px;
      right: 10px;
    }

    .triangle-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: 800;
      color: #5a4a3a;
      text-align: center;
      background: rgba(244, 229, 193, 0.95);
      padding: 16px 20px;
      border-radius: 8px;
      border: 3px solid #8b6f47;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .formula {
      font-size: 24px;
      font-weight: 800;
      color: #5a4a3a;
      margin-top: 20px;
      font-style: italic;
    }

    /* Philosophy Modal */
    .philosophy-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .philosophy-modal.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .philosophy-modal-content {
      position: relative;
      width: min(1400px, 95vw);
      max-height: 90vh;
      background: #f4e5c1;
      border-radius: 12px;
      box-shadow: 0 14px 0 rgba(0, 0, 0, 0.4);
      overflow-y: auto;
      padding: 40px;
      z-index: 10;
      border: 4px solid #8b6f47;
    }

    .philosophy-layout {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 30px;
      margin-top: 30px;
    }

    @media (max-width: 1200px) {
      .philosophy-layout {
        grid-template-columns: 1fr;
      }
    }

    .philosophy-column {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .philosophy-text-block {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #e0d5c0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .philosophy-text-block p {
      font-size: 16px;
      line-height: 1.8;
      color: #3e2b18;
      margin: 0;
    }

    .philosophy-illustration {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #e0d5c0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
    }

    .philosophy-section {
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      border: 2px solid #e0d5c0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .philosophy-section h2 {
      font-size: 28px;
      color: #5a4a3a;
      font-weight: 900;
      margin-bottom: 16px;
      text-align: center;
      letter-spacing: 0.05em;
    }

    .philosophy-section h3 {
      font-size: 22px;
      color: #8b6f47;
      font-weight: 700;
      margin-top: 20px;
      margin-bottom: 12px;
      text-align: center;
      font-style: italic;
    }

    .goldilocks-bowls {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      margin: 30px 0;
      gap: 20px;
      flex-wrap: wrap;
    }

    .bowl-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      min-width: 150px;
      max-width: 220px;
    }

    .bowl {
      width: 140px;
      height: 90px;
      border: 4px solid #8b6f47;
      border-radius: 0 0 70px 70px;
      position: relative;
      background: #fff;
      margin-bottom: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .bowl-content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, #ff8c42, #ffa500);
      border-radius: 0 0 66px 66px;
      transition: height 0.3s ease;
    }

    .bowl.too-little .bowl-content {
      height: 20%;
    }

    .bowl.just-right .bowl-content {
      height: 55%;
    }

    .bowl.too-much .bowl-content {
      height: 95%;
      overflow: visible;
    }

    .bowl-label {
      text-align: center;
      font-size: 13px;
      color: #5a4a3a;
      font-weight: 600;
      margin-top: 10px;
      line-height: 1.5;
      padding: 0 8px;
    }

    .bowl-emoji {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 36px;
      z-index: 2;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .philosophy-summary {
      background: linear-gradient(135deg, #f4e5c1, #e4c57b);
      padding: 30px;
      border-radius: 12px;
      border: 3px solid #8b6f47;
      margin-top: 20px;
    }

    .philosophy-summary h2 {
      font-size: 32px;
      color: #5a4a3a;
      font-weight: 900;
      margin-bottom: 20px;
      text-align: center;
    }

    .philosophy-summary p {
      font-size: 18px;
      line-height: 1.8;
      color: #3e2b18;
      margin-bottom: 16px;
      text-align: center;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
    }

    .modal-content {
      position: relative;
      width: min(1000px, 94vw);
      max-height: 80vh;
      background: #e4c57b;
      border-radius: 10px;
      box-shadow: 0 14px 0 rgba(0, 0, 0, 0.4);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 18px 26px 20px;
      z-index: 10;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 12px;
    }

    .modal-title {
      font-size: clamp(26px, 3vw, 30px);
      letter-spacing: 0.18em;
      font-weight: 800;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #dc3545;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease, background-color 0.2s ease;
      padding: 0;
      font-size: 0;
    }

    .modal-close:hover {
      background-color: #c82333;
      transform: scale(1.1);
    }

    .modal-close:active {
      transform: scale(0.95);
    }

    .modal-close::before,
    .modal-close::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 3px;
      background-color: white;
      border-radius: 2px;
    }

    .modal-close::before {
      transform: rotate(45deg);
    }

    .modal-close::after {
      transform: rotate(-45deg);
    }

    .modal-body {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 18px;
    }

    @media (max-width: 800px) {
      .modal-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .modal-text {
      font-size: 14px;
      line-height: 1.5;
    }

    .modal-text h3 {
      font-size: 16px;
      margin-bottom: 6px;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      padding-top: 60%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 6px 0 rgba(0, 0, 0, 0.3);
      background: #c49a4c;
    }

    .video-wrapper iframe,
    .video-wrapper video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      object-fit: cover;
    }

    .modal-media {
      display: flex;
      flex-direction: column;
    }

    .add-to-cart-button {
      margin-top: 16px;
      padding: 14px 40px;
      font-size: 18px;
      font-weight: 700;
      border-radius: 8px;
      border: 2px solid #8b6f47;
      background: #f4e5c1;
      color: #5a4a3a;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 6px 0 #8b6f47;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .add-to-cart-button:hover {
      background: #e4c57b;
      transform: translateY(-2px);
      box-shadow: 0 9px 0 #8b6f47;
    }

    .add-to-cart-button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 0 #8b6f47;
    }

    .buy-button {
      margin-top: 0;
      padding: 14px 40px;
      font-size: 18px;
      font-weight: 700;
      border-radius: 8px;
      border: none;
      background: #3f8d3a;
      color: #fdf6e4;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 6px 0 #275824;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .buy-button:hover {
      background: #4fa34a;
      transform: translateY(-2px);
      box-shadow: 0 9px 0 #275824;
    }

    .buy-button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 0 #275824;
    }

    .visualize-button {
      margin-top: 16px;
      padding: 12px 32px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 50px;
      border: none;
      background: #e8e8e8;
      color: #3a7bc8;
      cursor: pointer;
      width: auto;
      display: inline-block;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .visualize-button:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .visualize-button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .fun-facts-button {
      margin-top: 16px;
      padding: 12px 32px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 50px;
      border: none;
      background: #ffa500;
      color: #fff;
      cursor: pointer;
      width: auto;
      display: inline-block;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .fun-facts-button:hover {
      background: #ff8c00;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .fun-facts-button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    /* Fun Facts Panel */
    .fun-facts-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .fun-facts-modal.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .fun-facts-modal-content {
      position: relative;
      width: min(900px, 90vw);
      max-height: 85vh;
      background: #f4e5c1;
      border-radius: 12px;
      box-shadow: 0 14px 0 rgba(0, 0, 0, 0.4);
      overflow-y: auto;
      padding: 30px 40px;
      z-index: 10;
      border: 4px solid #8b6f47;
    }

    /* Notification Popup */
    .notification-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .notification-popup.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }

    .notification-content {
      position: relative;
      background: #f4e5c1;
      border-radius: 12px;
      box-shadow: 0 8px 0 rgba(0, 0, 0, 0.3);
      padding: 24px 48px 24px 24px;
      border: 3px solid #8b6f47;
      min-width: 300px;
      max-width: 500px;
      text-align: center;
    }

    .notification-content p {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #5a4a3a;
      line-height: 1.4;
    }

    .notification-close {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border: none;
      background: #8a2a2a;
      color: #fdf6e4;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      padding: 0;
      transition: background 0.2s ease;
    }

    .notification-close:hover {
      background: #a03030;
    }

    .fun-facts-header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 3px solid #8b6f47;
    }

    .fun-facts-header h2 {
      font-size: clamp(28px, 3vw, 36px);
      color: #5a4a3a;
      font-weight: 900;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .fun-facts-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    .fun-facts-image {
      width: 100%;
      max-width: 100%;
      height: auto;
      border-radius: 12px;
      border: 3px solid #8b6f47;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    /* Ingredient Visualization */
    .ingredient-marker {
      position: fixed;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid #f5f0e4;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: 8;
      display: none;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .ingredient-marker:hover {
      transform: scale(1.1);
      z-index: 25;
    }

    /* Ingredient Info Popup */
    .ingredient-popup {
      position: fixed;
      width: min(600px, calc(90vw - 40px));
      max-height: calc(85vh - 40px);
      background: #f4e5c1;
      border: 4px solid #8b6f47;
      border-radius: 12px;
      box-shadow: 0 14px 0 rgba(0, 0, 0, 0.4);
      z-index: 30;
      display: none;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 24px;
      pointer-events: auto;
      max-width: calc(100vw - 40px);
      box-sizing: border-box;
    }

    .ingredient-popup.visible {
      display: block;
    }

    .ingredient-popup-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 3px solid #8b6f47;
    }

    .ingredient-popup-header h3 {
      font-size: 24px;
      font-weight: 900;
      color: #3e2b18;
      text-shadow: 2px 2px 0 #f4e5c1;
      margin-bottom: 8px;
    }

    .ingredient-popup-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .ingredient-popup-image-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .ingredient-popup-image-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .ingredient-popup-image {
      width: 100%;
      height: auto;
      border-radius: 8px;
      border: 3px solid #8b6f47;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .ingredient-popup-image-caption {
      background: linear-gradient(to bottom, #b8966a, #a0825a);
      color: #f9e0b5;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      border: 2px solid #8b6f47;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .ingredient-popup-text {
      background: #e4c57b;
      padding: 20px;
      border-radius: 8px;
      border: 3px solid #8b6f47;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .ingredient-popup-text p {
      color: #3e2b18;
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .ingredient-popup-text p:last-child {
      margin-bottom: 0;
    }

    .ingredient-popup-text strong {
      color: #5a4a3a;
      font-weight: 700;
    }

    .ingredient-popup-text em {
      font-style: italic;
      color: #8b6f47;
    }

    /* Coffee Popup - Square cohesive block */
    .coffee-popup-container {
      position: fixed;
      display: none;
      z-index: 30;
      pointer-events: auto;
      width: 800px;
      height: 800px;
      background: #f4e5c1;
      border: 4px solid #8b6f47;
      border-radius: 12px;
      box-shadow: 0 14px 0 rgba(0, 0, 0, 0.4);
      padding: 20px;
      box-sizing: border-box;
      overflow: hidden;
    }

    .coffee-popup-container.visible {
      display: block;
    }

    .coffee-popup-header {
      text-align: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 3px solid #8b6f47;
    }

    .coffee-popup-header h3 {
      font-size: 24px;
      font-weight: 900;
      color: #3e2b18;
      text-shadow: 2px 2px 0 #f4e5c1;
      margin: 0;
    }

    .coffee-popup-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 16px;
      height: calc(100% - 60px);
      width: 100%;
    }

    .coffee-popup-item {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-radius: 8px;
    }

    .coffee-popup-image-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .coffee-popup-image {
      width: 100%;
      height: auto;
      max-height: 280px;
      object-fit: cover;
      border-radius: 8px;
      border: 3px solid #8b6f47;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }

    .coffee-popup-video {
      width: 100%;
      height: auto;
      max-height: 280px;
      object-fit: cover;
      border-radius: 8px;
      border: 3px solid #8b6f47;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }

    .coffee-caption-green {
      background: linear-gradient(to bottom, #4a7c3e, #3d6b32);
      color: #f9e0b5;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      border: 2px solid #2d4a25;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
    }

    .coffee-popup-item .coffee-text-box-brown {
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, #6b4e3a, #5a3e2a);
      color: #f4e5c1 !important;
      padding: 20px;
      border-radius: 10px;
      border: 3px solid #4a3424;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5), inset 0 2px 6px rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      justify-content: center;
      overflow: hidden;
    }

    .coffee-text-box-brown p {
      color: #f4e5c1 !important;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 12px;
      margin-top: 0;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .coffee-text-box-brown p:last-child {
      margin-bottom: 0;
    }

    .coffee-text-box-brown em {
      font-style: italic;
      color: #d4b896 !important;
      font-weight: 500;
    }

    /* Cursor Ship */
    .cursor-ship {
      position: fixed;
      z-index: 15;
      pointer-events: none;
      width: 80px;
      height: 60px;
      opacity: 0;
      transition: opacity 0.3s ease;
      transform-origin: center center;
    }

    .cursor-ship.visible {
      opacity: 0.9;
    }

    .cursor-ship svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      animation: shipSway 3s ease-in-out infinite;
    }

    @keyframes shipSway {
      0%, 100% {
        transform: rotate(-2deg);
      }
      50% {
        transform: rotate(2deg);
      }
    }

    /* Cursor Caravan */
    .cursor-caravan {
      position: fixed;
      z-index: 15;
      pointer-events: none;
      width: 90px;
      height: 60px;
      opacity: 0;
      transition: opacity 0.3s ease;
      transform-origin: center center;
    }

    .cursor-caravan.visible {
      opacity: 0.9;
    }

    .cursor-caravan svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      animation: caravanBounce 2s ease-in-out infinite;
    }

    @keyframes caravanBounce {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-3px);
      }
    }

    /* Footprint Trail */
    .footprint-trail-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 15;
      pointer-events: none;
      overflow: hidden;
    }

    .footprint {
      position: absolute;
      width: 30px;
      height: 30px;
      opacity: 0;
      pointer-events: none;
      animation: footprintFade 3s ease-out forwards;
    }

    .footprint svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
    }

    @keyframes footprintFade {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }
      10% {
        opacity: 0.8;
        transform: scale(1);
      }
      90% {
        opacity: 0.8;
        transform: scale(1);
      }
      100% {
        opacity: 0;
        transform: scale(0.9);
      }
    }

    /* Sea Dragon Animation */
    .sea-dragon {
      position: fixed;
      z-index: 8;
      pointer-events: none;
      width: 200px;
      height: 120px;
      opacity: 0.9;
      filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.4));
    }

    .sea-dragon svg {
      width: 100%;
      height: 100%;
      animation: swim 10s ease-in-out infinite;
    }

    @keyframes swim {
      0%, 100% {
        transform: translateX(0) translateY(0) rotate(0deg);
      }
      25% {
        transform: translateX(40px) translateY(-15px) rotate(3deg);
      }
      50% {
        transform: translateX(80px) translateY(0) rotate(0deg);
      }
      75% {
        transform: translateX(40px) translateY(15px) rotate(-3deg);
      }
    }

    .sea-dragon:hover {
      opacity: 1;
      transform: scale(1.15);
      transition: opacity 0.3s, transform 0.3s;
      filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.5));
    }

    .ingredient-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      color: #3e2b18;
      white-space: nowrap;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      pointer-events: none;
    }

    .ingredient-marker.yellow-label .ingredient-label {
      background: #ffd700;
      color: #3e2b18;
    }

    .ingredient-marker.pink-label .ingredient-label {
      background: #ffb6c1;
      color: #3e2b18;
    }

    .visualization-mode .token,
    .visualization-mode .sign-container,
    .visualization-mode .navbar,
    .visualization-mode .hint {
      display: none !important;
    }

    .return-button {
      position: fixed;
      top: 80px;
      left: 20px;
      z-index: 20;
      background: #8b1a1a;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      display: none;
      transition: background 0.2s ease;
    }

    .return-button:hover {
      background: #a82a2a;
    }

    .visualization-mode .return-button {
      display: block;
    }

    .ingredient-title {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 20;
      background: linear-gradient(to bottom, #8b6f47, #6b5a3a);
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 800;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      border: 3px solid #5a4a3a;
      display: none;
    }

    .visualization-mode .ingredient-title {
      display: block;
    }

    /* Passport UI - Silk Road Trade Permits */
    .passport-container {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 280px;
      max-height: calc(100vh - 100px);
      background: linear-gradient(135deg, #f4e5c1, #e4c57b);
      border: 4px solid #8b6f47;
      border-radius: 12px;
      box-shadow: 0 8px 0 rgba(0, 0, 0, 0.3);
      z-index: 20;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .passport-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 0 rgba(0, 0, 0, 0.35);
    }

    .passport-header {
      background: linear-gradient(to bottom, #8b6f47, #6b5a4a);
      padding: 16px;
      text-align: center;
      border-bottom: 3px solid #5a4a3a;
    }

    .passport-title {
      font-size: 20px;
      font-weight: 900;
      color: #f9e0b5;
      text-shadow: 2px 2px 0 #5a4a3a;
      letter-spacing: 0.1em;
      margin: 0;
    }

    .passport-subtitle {
      font-size: 11px;
      color: #e4c57b;
      margin-top: 4px;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .passport-body {
      padding: 16px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .passport-stamps-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    .passport-stamp {
      aspect-ratio: 1;
      border: 3px solid #8b6f47;
      border-radius: 8px;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }

    .passport-stamp.locked {
      background: linear-gradient(135deg, #e0d5c0, #d0c5b0);
      opacity: 0.6;
      cursor: not-allowed;
    }

    .passport-stamp.unlocked {
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .passport-stamp.unlocked:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .passport-stamp.unlocked.animate {
      animation: stampEarned 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes stampEarned {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .stamp-icon {
      font-size: 32px;
      margin-bottom: 4px;
      filter: drop-shadow(1px 1px 2px rgba(0, 0, 0, 0.2));
    }

    .stamp-label {
      font-size: 9px;
      font-weight: 700;
      color: #5a4a3a;
      text-align: center;
      line-height: 1.2;
      padding: 0 4px;
    }

    .passport-stamp.locked .stamp-label {
      color: #8b6f47;
    }

    .stamp-lock-icon {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 14px;
      color: #8b6f47;
      opacity: 0.7;
    }

    .passport-stats {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid #8b6f47;
      text-align: center;
    }

    .passport-stats-text {
      font-size: 12px;
      color: #5a4a3a;
      font-weight: 600;
    }

    .passport-stats-number {
      font-size: 24px;
      font-weight: 900;
      color: #8b6f47;
      margin-top: 4px;
    }

    /* Locked token message */
    .token-locked-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #f4e5c1, #e4c57b);
      border: 4px solid #8b6f47;
      border-radius: 12px;
      padding: 24px 32px;
      box-shadow: 0 8px 0 rgba(0, 0, 0, 0.3);
      z-index: 100;
      text-align: center;
      max-width: 400px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .token-locked-message.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .token-locked-message h3 {
      font-size: 20px;
      color: #5a4a3a;
      font-weight: 800;
      margin-bottom: 12px;
      letter-spacing: 0.05em;
    }

    .token-locked-message p {
      font-size: 14px;
      color: #3e2b18;
      line-height: 1.6;
      margin: 0;
    }

    .token-locked-close {
      margin-top: 16px;
      padding: 8px 20px;
      background: #8b6f47;
      color: #f9e0b5;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .token-locked-close:hover {
      background: #6b5a4a;
    }

    /* Token lock indicator */
    .token.locked::before {
      content: '🔒';
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 24px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 10;
    }

    /* Checkout panel */

    .checkout {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      max-height: 70vh;
      background: #f4e5c1;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -10px 0 rgba(0, 0, 0, 0.25);
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      z-index: 60;
      display: flex;
      flex-direction: column;
    }

    .checkout.visible {
      transform: translateY(0%);
    }

    .checkout-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 18px 4px;
      font-size: 14px;
      font-weight: 600;
      position: relative;
    }

    .checkout-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #dc3545;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease, background-color 0.2s ease;
      padding: 0;
      font-size: 0;
    }

    .checkout-close:hover {
      background-color: #c82333;
      transform: scale(1.1);
    }

    .checkout-close:active {
      transform: scale(0.95);
    }

    .checkout-close::before,
    .checkout-close::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 3px;
      background-color: white;
      border-radius: 2px;
    }

    .checkout-close::before {
      transform: rotate(45deg);
    }

    .checkout-close::after {
      transform: rotate(-45deg);
    }

    .checkout-body {
      flex: 1;
      border-top: 1px solid rgba(0, 0, 0, 0.12);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .checkout-content {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .checkout-summary {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .checkout-summary h3 {
      margin-bottom: 12px;
      font-size: 18px;
      color: #3e2b18;
    }

    .checkout-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .checkout-item:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 16px;
      margin-top: 8px;
      padding-top: 12px;
      border-top: 2px solid rgba(0, 0, 0, 0.1);
    }

    .payment-methods {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .payment-methods h3 {
      margin-bottom: 16px;
      font-size: 18px;
      color: #3e2b18;
    }

    .payment-option {
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 12px;
      border: 2px solid #e0d5c0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fff;
    }

    .payment-option:hover {
      border-color: #3f8d3a;
      background: #f9f7f2;
    }

    .payment-option.selected {
      border-color: #3f8d3a;
      background: #f0f8ef;
    }

    .payment-option input[type="radio"] {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .payment-option label {
      flex: 1;
      cursor: pointer;
      font-weight: 600;
      color: #3e2b18;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .payment-icon {
      font-size: 24px;
    }

    .payment-details {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #3e2b18;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0d5c0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #3f8d3a;
    }

    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
    }

    .checkout-body iframe {
      border: none;
      width: 100%;
      height: 100%;
      display: none;
    }

    .checkout-body iframe.active {
      display: block;
    }

    /* PayPal Card Fields Styling */
    .card_container {
      padding: 16px;
      border: 2px solid #e0d5c0;
      border-radius: 6px;
      background: #fff;
      margin-bottom: 16px;
    }

    .card_container:focus-within {
      border-color: #3f8d3a;
      outline: none;
    }

    #card-name-field-container,
    #card-number-field-container,
    #card-expiry-field-container,
    #card-cvv-field-container {
      margin-bottom: 12px;
      min-height: 50px;
    }

    /* PayPal card field input styling */
    .card_container input[data-paypal-target] {
      padding: 10px;
      border: 2px solid #e0d5c0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s ease;
    }

    .card_container input[data-paypal-target]:focus {
      outline: none;
      border-color: #3f8d3a;
    }

    #card-fields-errors {
      color: #dc3545;
      margin-top: 8px;
      font-size: 14px;
      min-height: 20px;
    }

    /* PayPal Buttons Styling */
    .paypal-buttons-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    paypal-button,
    paypal-pay-later-button,
    paypal-credit-button {
      width: 100%;
      min-height: 48px;
    }

    /* Footer note */

    .hint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      font-size: 18px;
      opacity: 0.8;
      text-align: center;
      color: #f5f3e9;
      z-index: 5;
      font-weight: 600;
      pointer-events: none;
    }

    /* Compass */
    .map-compass {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 120px;
      height: 120px;
      z-index: 5;
      pointer-events: none;
    }

    .compass-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Navigation Bar -->
    <nav class="navbar">
      <a href="#" class="navbar-brand">PAPO'S of the World</a>
      <ul class="navbar-nav">
        <li><a href="#why-desnac">Why deSnac?</a></li>
        <li><a href="#philosophy">Our Philosophy</a></li>
        <li><a href="#nutrition">Nutrition</a></li>
        <li>
          <svg class="navbar-cart" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
          </svg>
        </li>
      </ul>
    </nav>

    <header class="sign-container">
      <div class="sign-hook"></div>
      <div class="sign-chains">
        <div class="chain-link"></div>
        <div class="chain-link"></div>
      </div>
      <div class="sign-planks">
        <div class="sign-top-plank">
          <div class="sign-title">PAPO'S</div>
          <div class="sign-slogan">
            <span class="desnac-text">deSnac</span> Like Nobody's Watching
          </div>
        </div>
        <div class="sign-connecting-chains" style="display: flex; gap: 300px; margin: 4px 0; justify-content: center; position: relative; z-index: 3;">
          <div class="chain-link-bottom"></div>
          <div class="chain-link-bottom"></div>
        </div>
        <div class="sign-bottom-plank">
          <div class="ai-search-container">
            <svg class="ai-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" class="ai-search-input" placeholder="Ask PAPO'S" id="aiSearchInput">
          </div>
        </div>
      </div>
    </header>

    <!-- World map background -->
    <main class="world-wrapper">
      <div id="world-map" class="world-map"></div>
      
      <!-- Compass -->
      <div class="map-compass">
        <img src="images/compass.png" alt="Compass" class="compass-image" id="compassImage" onerror="this.style.display='none';">
      </div>
      
      <!-- Cursor Ship -->
      <div class="cursor-ship" id="cursorShip">
        <svg width="80" height="60" viewBox="0 0 80 60" xmlns="http://www.w3.org/2000/svg">
          <!-- Hull -->
          <path d="M 10 45 L 70 45 L 65 50 L 15 50 Z" fill="#8b6f47" stroke="#5a4a3a" stroke-width="2"/>
          <!-- Deck -->
          <path d="M 15 45 L 65 45 L 60 40 L 20 40 Z" fill="#a0825a" stroke="#8b6f47" stroke-width="1.5"/>
          <!-- Mast -->
          <line x1="40" y1="40" x2="40" y2="15" stroke="#5a4a3a" stroke-width="3"/>
          <!-- Main sail -->
          <path d="M 40 25 L 40 40 L 55 35 Z" fill="#f5f0e4" stroke="#d4c5a8" stroke-width="1.5"/>
          <!-- Fore sail -->
          <path d="M 40 30 L 40 40 L 25 35 Z" fill="#e8dcc5" stroke="#d4c5a8" stroke-width="1.5"/>
          <!-- Flag -->
          <path d="M 40 15 L 40 20 L 45 18 Z" fill="#c0392b" stroke="#a93226" stroke-width="1"/>
          <!-- Portholes -->
          <circle cx="30" cy="47" r="2" fill="#2d5a8f" opacity="0.7"/>
          <circle cx="50" cy="47" r="2" fill="#2d5a8f" opacity="0.7"/>
          <!-- Bow decoration -->
          <circle cx="12" cy="47" r="1.5" fill="#d4a574"/>
        </svg>
      </div>
      
      <!-- Cursor Caravan -->
      <div class="cursor-caravan" id="cursorCaravan">
        <svg width="90" height="60" viewBox="0 0 90 60" xmlns="http://www.w3.org/2000/svg">
          <!-- Wagon body -->
          <rect x="10" y="30" width="70" height="25" fill="#8b6f47" stroke="#5a4a3a" stroke-width="2" rx="2"/>
          <!-- Wagon top/roof -->
          <path d="M 10 30 L 40 20 L 50 20 L 80 30 Z" fill="#a0825a" stroke="#8b6f47" stroke-width="2"/>
          <!-- Wagon door -->
          <rect x="35" y="35" width="20" height="15" fill="#6b5a3a" stroke="#5a4a3a" stroke-width="1.5"/>
          <!-- Door handle -->
          <circle cx="52" cy="42" r="1.5" fill="#d4a574"/>
          <!-- Windows -->
          <rect x="18" y="32" width="12" height="10" fill="#2d5a8f" opacity="0.6" stroke="#1a3a5f" stroke-width="1"/>
          <rect x="60" y="32" width="12" height="10" fill="#2d5a8f" opacity="0.6" stroke="#1a3a5f" stroke-width="1"/>
          <!-- Wheels -->
          <circle cx="25" cy="55" r="6" fill="#3a3a3a" stroke="#2a2a2a" stroke-width="1.5"/>
          <circle cx="25" cy="55" r="3" fill="#5a5a5a"/>
          <circle cx="65" cy="55" r="6" fill="#3a3a3a" stroke="#2a2a2a" stroke-width="1.5"/>
          <circle cx="65" cy="55" r="3" fill="#5a5a5a"/>
          <!-- Wheel spokes -->
          <line x1="25" y1="55" x2="25" y2="49" stroke="#2a2a2a" stroke-width="1"/>
          <line x1="25" y1="55" x2="25" y2="61" stroke="#2a2a2a" stroke-width="1"/>
          <line x1="25" y1="55" x2="20" y2="55" stroke="#2a2a2a" stroke-width="1"/>
          <line x1="25" y1="55" x2="30" y2="55" stroke="#2a2a2a" stroke-width="1"/>
          <line x1="65" y1="55" x2="65" y2="49" stroke="#2a2a2a" stroke-width="1"/>
          <line x1="65" y1="55" x2="65" y2="61" stroke="#2a2a2a" stroke-width="1"/>
          <line x1="65" y1="55" x2="60" y2="55" stroke="#2a2a2a" stroke-width="1"/>
          <line x1="65" y1="55" x2="70" y2="55" stroke="#2a2a2a" stroke-width="1"/>
          <!-- Decorative stripes on roof -->
          <line x1="15" y1="28" x2="75" y2="28" stroke="#8b6f47" stroke-width="1"/>
          <line x1="15" y1="26" x2="75" y2="26" stroke="#8b6f47" stroke-width="1"/>
        </svg>
      </div>
      
      <!-- Footprint Trail Container -->
      <div class="footprint-trail-container" id="footprintTrailContainer"></div>
      
      <!-- Animated Sea Dragon -->
      <div class="sea-dragon" id="seaDragon" data-lat="0" data-lng="-150">
        <svg width="200" height="120" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg">
          <!-- Serpentine body (coiled) -->
          <path d="M 30 60 Q 50 50, 70 60 Q 90 70, 110 60 Q 130 50, 150 60 Q 170 70, 180 60" 
                stroke="#2d5a2d" stroke-width="8" fill="none" opacity="0.9">
            <animate attributeName="d" 
                     values="M 30 60 Q 50 50, 70 60 Q 90 70, 110 60 Q 130 50, 150 60 Q 170 70, 180 60;M 30 62 Q 50 52, 70 62 Q 90 72, 110 62 Q 130 52, 150 62 Q 170 72, 180 62;M 30 60 Q 50 50, 70 60 Q 90 70, 110 60 Q 130 50, 150 60 Q 170 70, 180 60" 
                     dur="4s" repeatCount="indefinite"/>
          </path>
          
          <!-- Body segments with scales -->
          <ellipse cx="50" cy="55" rx="12" ry="8" fill="#4a7c4a" stroke="#2d5a2d" stroke-width="2" opacity="0.9">
            <animate attributeName="cy" values="55;57;55" dur="3s" repeatCount="indefinite"/>
          </ellipse>
          <ellipse cx="70" cy="60" rx="12" ry="8" fill="#4a7c4a" stroke="#2d5a2d" stroke-width="2" opacity="0.9">
            <animate attributeName="cy" values="60;62;60" dur="3s" repeatCount="indefinite"/>
          </ellipse>
          <ellipse cx="90" cy="65" rx="12" ry="8" fill="#4a7c4a" stroke="#2d5a2d" stroke-width="2" opacity="0.9">
            <animate attributeName="cy" values="65;67;65" dur="3s" repeatCount="indefinite"/>
          </ellipse>
          <ellipse cx="110" cy="60" rx="12" ry="8" fill="#4a7c4a" stroke="#2d5a2d" stroke-width="2" opacity="0.9">
            <animate attributeName="cy" values="60;62;60" dur="3s" repeatCount="indefinite"/>
          </ellipse>
          <ellipse cx="130" cy="55" rx="12" ry="8" fill="#4a7c4a" stroke="#2d5a2d" stroke-width="2" opacity="0.9">
            <animate attributeName="cy" values="55;57;55" dur="3s" repeatCount="indefinite"/>
          </ellipse>
          <ellipse cx="150" cy="60" rx="12" ry="8" fill="#4a7c4a" stroke="#2d5a2d" stroke-width="2" opacity="0.9">
            <animate attributeName="cy" values="60;62;60" dur="3s" repeatCount="indefinite"/>
          </ellipse>
          
          <!-- Circular scales pattern -->
          <circle cx="50" cy="55" r="3" fill="#5a8c5a" opacity="0.6">
            <animate attributeName="cy" values="55;57;55" dur="3s" repeatCount="indefinite"/>
          </circle>
          <circle cx="70" cy="60" r="3" fill="#5a8c5a" opacity="0.6">
            <animate attributeName="cy" values="60;62;60" dur="3s" repeatCount="indefinite"/>
          </circle>
          <circle cx="90" cy="65" r="3" fill="#5a8c5a" opacity="0.6">
            <animate attributeName="cy" values="65;67;65" dur="3s" repeatCount="indefinite"/>
          </circle>
          <circle cx="110" cy="60" r="3" fill="#5a8c5a" opacity="0.6">
            <animate attributeName="cy" values="60;62;60" dur="3s" repeatCount="indefinite"/>
          </circle>
          <circle cx="130" cy="55" r="3" fill="#5a8c5a" opacity="0.6">
            <animate attributeName="cy" values="55;57;55" dur="3s" repeatCount="indefinite"/>
          </circle>
          <circle cx="150" cy="60" r="3" fill="#5a8c5a" opacity="0.6">
            <animate attributeName="cy" values="60;62;60" dur="3s" repeatCount="indefinite"/>
          </circle>
          
          <!-- Dragon-like head -->
          <ellipse cx="25" cy="60" rx="18" ry="14" fill="#5a8c5a" stroke="#2d5a2d" stroke-width="2.5" opacity="0.95">
            <animate attributeName="cy" values="60;62;60" dur="3s" repeatCount="indefinite"/>
          </ellipse>
          
          <!-- Open mouth with teeth -->
          <path d="M 15 60 L 10 55 L 10 65 Z" fill="#ffffff" stroke="#2d5a2d" stroke-width="1.5">
            <animate attributeName="d" values="M 15 60 L 10 55 L 10 65 Z;M 15 62 L 10 57 L 10 67 Z;M 15 60 L 10 55 L 10 65 Z" dur="3s" repeatCount="indefinite"/>
          </path>
          <line x1="12" y1="58" x2="12" y2="62" stroke="#2d5a2d" stroke-width="1">
            <animate attributeName="y1" values="58;60;58" dur="3s" repeatCount="indefinite"/>
            <animate attributeName="y2" values="62;64;62" dur="3s" repeatCount="indefinite"/>
          </line>
          
          <!-- Large eyes -->
          <circle cx="20" cy="58" r="4" fill="#ffffff" stroke="#2d5a2d" stroke-width="1.5">
            <animate attributeName="cy" values="58;60;58" dur="3s" repeatCount="indefinite"/>
          </circle>
          <circle cx="20" cy="58" r="2.5" fill="#000000">
            <animate attributeName="cy" values="58;60;58" dur="3s" repeatCount="indefinite"/>
          </circle>
          
          <!-- Spikes/horns on head -->
          <polygon points="25,45 28,40 31,45" fill="#8b6f47" stroke="#5a4a3a" stroke-width="1.5">
            <animate attributeName="points" values="25,45 28,40 31,45;25,47 28,42 31,47;25,45 28,40 31,45" dur="3s" repeatCount="indefinite"/>
          </polygon>
          <polygon points="30,48 33,43 36,48" fill="#8b6f47" stroke="#5a4a3a" stroke-width="1.5">
            <animate attributeName="points" values="30,48 33,43 36,48;30,50 33,45 36,50;30,48 33,43 36,48" dur="3s" repeatCount="indefinite"/>
          </polygon>
          
          <!-- Fins along back -->
          <ellipse cx="60" cy="45" rx="6" ry="10" fill="#3d6b3d" opacity="0.8" transform="rotate(-15 60 45)">
            <animate attributeName="cy" values="45;47;45" dur="2.5s" repeatCount="indefinite"/>
            <animate attributeName="transform" values="rotate(-15 60 45);rotate(-10 60 45);rotate(-15 60 45)" dur="2.5s" repeatCount="indefinite"/>
          </ellipse>
          <ellipse cx="90" cy="50" rx="6" ry="10" fill="#3d6b3d" opacity="0.8" transform="rotate(-10 90 50)">
            <animate attributeName="cy" values="50;52;50" dur="2.5s" repeatCount="indefinite"/>
            <animate attributeName="transform" values="rotate(-10 90 50);rotate(-5 90 50);rotate(-10 90 50)" dur="2.5s" repeatCount="indefinite"/>
          </ellipse>
          <ellipse cx="130" cy="45" rx="6" ry="10" fill="#3d6b3d" opacity="0.8" transform="rotate(-15 130 45)">
            <animate attributeName="cy" values="45;47;45" dur="2.5s" repeatCount="indefinite"/>
            <animate attributeName="transform" values="rotate(-15 130 45);rotate(-10 130 45);rotate(-15 130 45)" dur="2.5s" repeatCount="indefinite"/>
          </ellipse>
          
          <!-- Tail -->
          <path d="M 170 60 Q 185 55, 190 60 Q 185 65, 170 60" fill="#3d6b3d" stroke="#2d5a2d" stroke-width="2" opacity="0.9">
            <animate attributeName="d" values="M 170 60 Q 185 55, 190 60 Q 185 65, 170 60;M 170 62 Q 185 57, 190 62 Q 185 67, 170 62;M 170 60 Q 185 55, 190 60 Q 185 65, 170 60" dur="3s" repeatCount="indefinite"/>
          </path>
        </svg>
      </div>
    </main>

    <!-- Ingredient Visualization -->
    <button class="return-button" id="returnButton">Click to Return</button>
    <div class="ingredient-title" id="ingredientTitle">CAFE CON CRUNCH INGREDIENTS</div>

    <!-- Ingredient Markers (hidden by default) -->
    <div class="ingredient-marker yellow-label" id="ingredient-coffee" data-lat="4.5709" data-lng="-74.2973" data-name="Coffee Beans" style="background-image: url('images/coffeebeans.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="ingredient-label">Coffee Beans</div>
    </div>

    <!-- Coffee Popup - Square cohesive block -->
    <div class="coffee-popup-container" id="coffee-popup">
      <div class="coffee-popup-header">
        <h3>Coffee Beans</h3>
      </div>
      <div class="coffee-popup-grid">
        <!-- Top-left: Image with rainbow -->
        <div class="coffee-popup-item coffee-popup-image-item">
          <img src="images/image of ceo next to sign.png" alt="CEO at Kauai Coffee Plantation" class="coffee-popup-image">
          <div class="coffee-caption-green">Our CEO with a rainbow at Kawaii Coffee Plantation</div>
          </div>
        
        <!-- Top-right: Aromatic compounds text -->
        <div class="coffee-popup-item coffee-text-box-brown">
          <p>Coffee contains over 800 aromatic compounds — more than wine.</p>
          <p>When brewed and dried, those aromas stay, while volatility disappears. That's why at PAPO'S we use it: to add depth without dominance, and complexity without noise.</p>
        </div>
        
        <!-- Bottom-left: Instant coffee text -->
        <div class="coffee-popup-item coffee-text-box-brown">
          <p>Instant Coffee is Coffee that has been brewed and then dried into a powder so that it can be reconstituted simply</p>
          <p>At Papo's, it provides the <em>earthy</em> backdrop to compliment the other Za'atar Seasonings</p>
        </div>
        
        <!-- Bottom-right: Image with coffee cup -->
        <div class="coffee-popup-item coffee-popup-image-item">
          <div class="coffee-caption-green">Largest Kawaii Cup to drink Huma-ahem, Coffee...</div>
          <img src="images/image of ceo in coffee cup.png" alt="CEO in Coffee Cup" class="coffee-popup-image">
        </div>
      </div>
    </div>

    <!-- Vanilla Popup - Square cohesive block -->
    <div class="coffee-popup-container" id="vanilla-popup">
      <div class="coffee-popup-header">
        <h3>Vanilla Bean</h3>
      </div>
      <div class="coffee-popup-grid">
        <!-- Top-left: Image with bee on flower -->
        <div class="coffee-popup-item coffee-popup-image-item">
           <img src="images/melonbee.png" alt="Melipona bee pollinating vanilla orchid" class="coffee-popup-image">
          <div class="coffee-caption-green">Melipona bee pollinating a vanilla orchid</div>
        </div>
        
        <!-- Top-right: First paragraph text -->
        <div class="coffee-popup-item coffee-text-box-brown">
          <p>In Madagascar and parts of Mexico, a tiny Melipona bee can naturally pollinate vanilla orchids. Everywhere else, that bee doesn't exist — which means vanilla flowers must be hand-pollinated, one bloom at a time, within a single morning.</p>
        </div>
        
        <!-- Bottom-left: Second paragraph text -->
        <div class="coffee-popup-item coffee-text-box-brown">
          <p>Miss the window, and the flower never becomes a bean.</p>
          <p>That fragility is why real vanilla tastes the way it does.</p>
        </div>
        
        <!-- Bottom-right: Third paragraph text -->
        <div class="coffee-popup-item coffee-text-box-brown">
          <p>It isn't mass-produced flavor — it's the result of timing, care, and attention.</p>
        </div>
      </div>
    </div>

    <!-- Za'atar Ingredient Popups -->
    <div class="ingredient-popup" id="sesame-popup">
      <div class="ingredient-popup-header">
        <h3>Sesame</h3>
      </div>
      <div class="ingredient-popup-content">
        <div class="ingredient-popup-image-section">
          <div class="ingredient-popup-image-item">
            <img src="images/sesame.png" alt="Sesame" class="ingredient-popup-image">
          </div>
        </div>
        <div class="ingredient-popup-text">
          <p>Toasted sesame seeds add a nutty, rich flavor and satisfying crunch to our Za'atar seasoning.</p>
        </div>
      </div>
    </div>

    <div class="ingredient-popup" id="sumac-popup">
      <div class="ingredient-popup-header">
        <h3>Sumac</h3>
      </div>
      <div class="ingredient-popup-content">
        <div class="ingredient-popup-image-section">
          <div class="ingredient-popup-image-item">
            <img src="images/sumac.png" alt="Sumac" class="ingredient-popup-image">
          </div>
        </div>
        <div class="ingredient-popup-text">
          <p>Sumac provides the citrusy tang that makes Za'atar so distinctive and refreshing.</p>
        </div>
      </div>
    </div>

    <div class="ingredient-popup" id="oliveoil-popup">
      <div class="ingredient-popup-header">
        <h3>Olive Oil</h3>
      </div>
      <div class="ingredient-popup-content">
        <div class="ingredient-popup-image-section">
          <div class="ingredient-popup-image-item">
            <img src="images/oliveoil.png" alt="Olive Oil" class="ingredient-popup-image">
          </div>
        </div>
        <div class="ingredient-popup-text">
          <p>Premium olive oil brings smooth richness and healthy fats to our Za'atar blend.</p>
        </div>
      </div>
    </div>

    <div class="ingredient-popup" id="salt-popup">
      <div class="ingredient-popup-header">
        <h3>Himalayan Salt</h3>
      </div>
      <div class="ingredient-popup-content">
        <div class="ingredient-popup-image-section">
          <div class="ingredient-popup-image-item">
            <img src="images/himalayan salt.png" alt="Himalayan Salt" class="ingredient-popup-image">
          </div>
        </div>
        <div class="ingredient-popup-text">
          <p>Himalayan salt adds a pure, mineral-rich flavor that enhances the natural taste of our Za'atar seasoning.</p>
        </div>
      </div>
    </div>

    <div class="ingredient-popup" id="foxnuts-popup">
      <div class="ingredient-popup-header">
        <h3>Foxnuts</h3>
      </div>
      <div class="ingredient-popup-content">
        <div class="ingredient-popup-image-section">
          <div class="ingredient-popup-image-item">
            <img src="images/foxnuts.png" alt="Foxnuts" class="ingredient-popup-image">
          </div>
        </div>
        <div class="ingredient-popup-text">
          <p>Foxnuts (makhana) are light, airy puffed lotus seeds that provide the perfect crunchy base for our Za'atar seasoning.</p>
        </div>
      </div>
    </div>

    <div class="ingredient-popup" id="blacktruffle-popup">
      <div class="ingredient-popup-header">
        <h3>Black Truffle</h3>
      </div>
      <div class="ingredient-popup-content">
        <div class="ingredient-popup-image-section">
          <div class="ingredient-popup-image-item">
            <img src="images/blacktruffle.png" alt="Black Truffle" class="ingredient-popup-image">
          </div>
        </div>
        <div class="ingredient-popup-text">
          <p>Black truffle from Périgord, France adds an earthy, luxurious depth to our Za'atar blend.</p>
        </div>
      </div>
    </div>

    <div class="ingredient-marker yellow-label" id="ingredient-sugar" data-lat="-14.2350" data-lng="-51.9253" data-name="Sugar" style="background-image: url('images/sugar.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="ingredient-label">Sugar</div>
    </div>
    <div class="ingredient-marker pink-label" id="ingredient-salt" data-lat="28.3949" data-lng="84.1240" data-name="Himalayan Salt" style="background-image: url('images/himalayan salt.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="ingredient-label">Himalayan Salt</div>
    </div>
    <div class="ingredient-marker pink-label" id="ingredient-foxnuts" data-lat="20.5937" data-lng="78.9629" data-name="Foxnuts" style="background-image: url('images/foxnuts.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="ingredient-label">Foxnuts</div>
    </div>
    <div class="ingredient-marker yellow-label" id="ingredient-coconut" data-lat="6.2088" data-lng="106.8456" data-name="Coconut Oil" style="background-image: url('images/coconutoil.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="ingredient-label">Coconut Oil</div>
    </div>
    <div class="ingredient-marker yellow-label" id="ingredient-vanilla" data-lat="-18.7669" data-lng="46.8691" data-name="Vanilla Bean" style="background-image: url('images/vanillabean.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="ingredient-label">Vanilla Bean</div>
    </div>

    <!-- Za'atar Ingredient Markers -->
    <div class="ingredient-marker yellow-label" id="ingredient-sesame" data-lat="31.7683" data-lng="35.2137" data-name="Sesame" style="background-image: url('images/sesame.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="ingredient-label">Sesame</div>
    </div>
    <div class="ingredient-marker yellow-label" id="ingredient-sumac" data-lat="37.0594" data-lng="37.3825" data-name="Sumac" style="background-image: url('images/sumac.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="ingredient-label">Sumac</div>
    </div>
    <div class="ingredient-marker yellow-label" id="ingredient-oliveoil" data-lat="41.1177" data-lng="16.8719" data-name="Olive Oil" style="background-image: url('images/oliveoil.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="ingredient-label">Olive Oil</div>
    </div>
    <div class="ingredient-marker yellow-label" id="ingredient-blacktruffle" data-lat="45.1833" data-lng="0.7167" data-name="Black Truffle" style="background-image: url('images/blacktruffle.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
      <div class="ingredient-label">Black Truffle</div>
    </div>

      <!-- Tokens. Replace backgrounds with your round token PNGs -->
      <button
        class="token token-granola"
        data-flavor-id="granola"
        data-label="Granola Cereal Fox-Nut"
      data-lat="37.3382"
      data-lng="-121.8863"
      >
        <!-- <div class="token-placeholder">Granola<br />Fox-Nut</div> -->
      </button>

      <button
        class="token token-jamaican"
        data-flavor-id="jamaican"
        data-label="Jamaican Jungle Flame"
        data-lat="18.0179"
        data-lng="-76.8099"
      >
        <!-- <div class="token-placeholder">Jamaican<br />Jungle Flame</div> -->
      </button>

      <button
        class="token token-cafe"
        data-flavor-id="cafe"
        data-label="Café Con Crunch"
        data-lat="-23.5505"
        data-lng="-46.6333"
      >
        <!-- <div class="token-placeholder">Café<br />Con Crunch</div> -->
      </button>

      <button
        class="token token-zaatar"
        data-flavor-id="zaatar"
        data-label="Za'atar"
        data-lat="33.8547"
        data-lng="35.8623"
      >
      <!-- <div class="token-placeholder">Za'atar</div> -->
      </button>

      <button
        class="token token-pumpkin"
        data-flavor-id="pumpkin"
        data-label="Candied Pumpkin"
        data-lat="39.9042"
        data-lng="116.4074"
      >
        <!-- <div class="token-placeholder">Candied<br />Pumpkin</div> -->
      </button>

      <button
        class="token token-orange"
        data-flavor-id="orange"
        data-label="Orange Maple"
        data-lat="43.6532"
        data-lng="-79.3832"
      >
        <!-- <div class="token-placeholder">Orange<br />Maple</div> -->
      </button>

      <button
        class="token token-pearlz"
        data-flavor-id="pearlz"
        data-label="Pearlz"
        data-lat="-17.6509"
        data-lng="-149.4264"
      >
      </button>

      <button
        class="token token-tomatoeouy"
        data-flavor-id="tomatoeouy"
        data-label="Tomatoe'ouy"
        data-lat="41.9028"
        data-lng="12.4964"
      >
      </button>

      <button
        class="token token-evergreenglow"
        data-flavor-id="evergreenglow"
        data-label="Evergreen Glow"
        data-lat="44.0682"
        data-lng="-114.7420"
      >
      </button>

      <button
        class="token token-totallynutz"
        data-flavor-id="totallynutz"
        data-label="Totally Nutz"
        data-lat="33.7490"
        data-lng="-84.3880"
      >
      </button>

      <button
        class="token token-barbecue"
        data-flavor-id="barbecue"
        data-label="Barbecue"
        data-lat="30.2672"
        data-lng="-97.7431"
      >
      </button>

      <button
        class="token token-bagel"
        data-flavor-id="bagel"
        data-label="Everything Bagel"
        data-lat="5.0"
        data-lng="20.0"
      >
      </button>

    <p class="hint">Click a token to explore each flavor's story.</p>

    <!-- Passport UI - Silk Road Trade Permits -->
    <div id="passportContainer" class="passport-container">
      <div class="passport-header">
        <h2 class="passport-title">TRADE PASSPORT</h2>
        <p class="passport-subtitle">Silk Road Permits</p>
      </div>
      <div class="passport-body">
        <div class="passport-stamps-grid" id="passportStampsGrid">
          <!-- Stamps will be generated by JavaScript -->
        </div>
        <div class="passport-stats">
          <div class="passport-stats-text">Flavors Discovered</div>
          <div class="passport-stats-number" id="passportStatsNumber">0</div>
        </div>
      </div>
    </div>

    <!-- Locked Token Message -->
    <div id="tokenLockedMessage" class="token-locked-message">
      <h3>Trade Route Locked</h3>
      <p>Traders from this land only open their gates to known travelers.</p>
      <p style="margin-top: 8px; font-size: 12px; font-style: italic;">Complete other flavors to unlock this trade route.</p>
      <button class="token-locked-close" onclick="document.getElementById('tokenLockedMessage').classList.remove('visible')">Continue Journey</button>
    </div>

    <!-- Flavor Modal -->
    <div id="flavorModal" class="modal">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle" class="modal-title">ZA'ATAR</h2>
          <button class="modal-close" id="modalCloseBtn"></button>
        </div>

        <div class="modal-body">
          <div class="modal-text">
            <h3 id="modalTagline">Warm, herbal, and cozy.</h3>
            <p id="modalDescription">
              <!-- Filled by JS -->
            </p>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <button id="visualizeButton" class="visualize-button">Visualize Ingredients</button>
              <button id="funFactsButton" class="fun-facts-button">Fun Facts</button>
            </div>
          </div>

          <div class="modal-media">
            <div class="video-wrapper">
              <!-- Use either a <video> tag or YouTube/Vimeo <iframe>. -->
              <!-- Here we'll use an iframe for max compatibility. -->
              <!-- <iframe
                id="modalVideo"
                src=""
                title="PAPO'S flavor animation"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              ></iframe> -->
              <video id="modalVideo" muted playsinline></video>
              <img id="modalImage" style="display: none; width: 100%; height: 100%; object-fit: contain;" alt="Flavor animation placeholder">
              <div id="comingSoonText" style="display: none; position: absolute; inset: 0; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; color: #3e2b18; text-shadow: 2px 2px 0 #f4e5c1;">Coming Soon!</div>

            </div>

            <div style="display: flex; gap: 12px; flex-direction: column;">
              <button id="addToCartButton" class="add-to-cart-button">Add to Cart</button>
            <button id="buyButton" class="buy-button">Buy Now</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Fun Facts Modal -->
    <div id="funFactsModal" class="fun-facts-modal">
      <div class="modal-backdrop"></div>
      <div class="fun-facts-modal-content">
        <button class="modal-close" id="funFactsCloseBtn"></button>
        <div class="fun-facts-header">
          <h2 id="funFactsTitle">Fun Facts</h2>
        </div>
        <div class="fun-facts-content" id="funFactsContent">
          <!-- Content will be filled by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Notification Popup -->
    <div id="notificationPopup" class="notification-popup">
      <div class="notification-content">
        <p id="notificationMessage"></p>
        <button class="notification-close" id="notificationCloseBtn">×</button>
      </div>
    </div>

    <!-- Checkout Panel -->
    <section id="checkoutPanel" class="checkout">
      <div class="checkout-header">
        <span id="checkoutTitle">Checkout</span>
        <button class="checkout-close" id="checkoutCloseBtn"></button>
      </div>
      <div class="checkout-body">
        <div class="checkout-content">
          <!-- Order Summary -->
          <div class="checkout-summary">
            <h3>Order Summary</h3>
            <div class="checkout-item">
              <span id="checkoutItemName">Item</span>
              <span id="checkoutItemPrice">$0.00</span>
            </div>
            <div class="checkout-item">
              <span>Shipping</span>
              <span>Free</span>
            </div>
            <div class="checkout-item">
              <span>Total</span>
              <span id="checkoutTotal">$0.00</span>
            </div>
          </div>

          <!-- Payment Methods -->
          <div class="payment-methods">
            <h3>Payment Method</h3>
            
            <div class="payment-option selected" data-payment="card">
              <input type="radio" id="payment-card" name="payment" value="card" checked>
              <label for="payment-card">
                <span class="payment-icon">💳</span>
                <span>Credit or Debit Card</span>
              </label>
            </div>

            <div class="payment-option" data-payment="paypal">
              <input type="radio" id="payment-paypal" name="payment" value="paypal">
              <label for="payment-paypal">
                <span class="payment-icon">🅿️</span>
                <span>PayPal</span>
              </label>
            </div>

            <div class="payment-option" data-payment="venmo">
              <input type="radio" id="payment-venmo" name="payment" value="venmo">
              <label for="payment-venmo">
                <span class="payment-icon">💸</span>
                <span>Venmo</span>
              </label>
            </div>

            <!-- Card Payment Details (PayPal Hosted Card Fields) -->
            <div class="payment-details" id="card-details">
              <div id="paypal-card-form" class="card_container">
                <div id="card-name-field-container"></div>
                <div id="card-number-field-container"></div>
                <div id="card-expiry-field-container"></div>
                <div id="card-cvv-field-container"></div>
                
                <div style="margin-top: 16px;">
                  <label for="card-billing-address-line-1" style="display: block; margin-bottom: 6px; font-weight: 600; color: #3e2b18; font-size: 14px;">Billing Address</label>
                  <input
                    type="text"
                    id="card-billing-address-line-1"
                    name="card-billing-address-line-1"
                    autocomplete="off"
                    placeholder="Address line 1"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px; margin-bottom: 8px;"
                  />
                </div>
                <div>
                  <input
                    type="text"
                    id="card-billing-address-line-2"
                    name="card-billing-address-line-2"
                    autocomplete="off"
                    placeholder="Address line 2 (optional)"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px; margin-bottom: 8px;"
                  />
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <input
                    type="text"
                    id="card-billing-address-admin-area-line-1"
                    name="card-billing-address-admin-area-line-1"
                    autocomplete="off"
                    placeholder="City"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px;"
                  />
                  <input
                    type="text"
                    id="card-billing-address-admin-area-line-2"
                    name="card-billing-address-admin-area-line-2"
                    autocomplete="off"
                    placeholder="State"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px;"
                  />
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                  <select
                    id="card-billing-address-country-code"
                    name="card-billing-address-country-code"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px; background: white;"
                  >
                    <option value="">Select Country</option>
                    <option value="US" selected>United States</option>
                    <option value="CA">Canada</option>
                    <option value="GB">United Kingdom</option>
                    <option value="AU">Australia</option>
                    <option value="DE">Germany</option>
                    <option value="FR">France</option>
                    <option value="IT">Italy</option>
                    <option value="ES">Spain</option>
                    <option value="MX">Mexico</option>
                    <option value="BR">Brazil</option>
                    <option value="JP">Japan</option>
                    <option value="CN">China</option>
                    <option value="IN">India</option>
                    <option value="KR">South Korea</option>
                    <option value="NL">Netherlands</option>
                    <option value="SE">Sweden</option>
                    <option value="NO">Norway</option>
                    <option value="DK">Denmark</option>
                    <option value="FI">Finland</option>
                    <option value="CH">Switzerland</option>
                    <option value="AT">Austria</option>
                    <option value="BE">Belgium</option>
                    <option value="IE">Ireland</option>
                    <option value="NZ">New Zealand</option>
                    <option value="SG">Singapore</option>
                    <option value="HK">Hong Kong</option>
                    <option value="TW">Taiwan</option>
                  </select>
                  <input
                    type="text"
                    id="card-billing-address-postal-code"
                    name="card-billing-address-postal-code"
                    autocomplete="off"
                    placeholder="Postal/Zip code"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px;"
                  />
                </div>
              </div>
              <div id="card-fields-errors" role="alert" style="color: #dc3545; margin-top: 8px; font-size: 14px; min-height: 20px;"></div>
              <button class="buy-button" id="card-field-submit-button" style="width: 100%; margin-top: 16px;">
                Pay now with Card
              </button>
            </div>

            <!-- PayPal Details (hidden by default) - Expanded Checkout with Buttons and Card Fields -->
            <div class="payment-details" id="paypal-details" style="display: none;">
              <!-- PayPal Buttons Container -->
              <div id="paypal-button-container" style="margin-top: 16px; margin-bottom: 24px;"></div>
              
              <!-- Divider -->
              <div style="display: flex; align-items: center; margin: 24px 0;">
                <div style="flex: 1; height: 1px; background: #e0d5c0;"></div>
                <div style="padding: 0 12px; color: #8b6f47; font-weight: 600;">OR</div>
                <div style="flex: 1; height: 1px; background: #e0d5c0;"></div>
              </div>
              
              <!-- PayPal Card Fields Container -->
              <div id="paypal-card-form-expanded" class="card_container" style="display: none;">
                <div id="card-name-field-container-expanded"></div>
                <div id="card-number-field-container-expanded"></div>
                <div id="card-expiry-field-container-expanded"></div>
                <div id="card-cvv-field-container-expanded"></div>
                
                <div style="margin-top: 16px;">
                  <label for="card-billing-address-line-1-expanded" style="display: block; margin-bottom: 6px; font-weight: 600; color: #3e2b18; font-size: 14px;">Billing Address</label>
                  <input
                    type="text"
                    id="card-billing-address-line-1-expanded"
                    name="card-billing-address-line-1-expanded"
                    autocomplete="off"
                    placeholder="Address line 1"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px; margin-bottom: 8px;"
                  />
                </div>
                <div>
                  <input
                    type="text"
                    id="card-billing-address-line-2-expanded"
                    name="card-billing-address-line-2-expanded"
                    autocomplete="off"
                    placeholder="Address line 2 (optional)"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px; margin-bottom: 8px;"
                  />
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <input
                    type="text"
                    id="card-billing-address-admin-area-line-1-expanded"
                    name="card-billing-address-admin-area-line-1-expanded"
                    autocomplete="off"
                    placeholder="City"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px;"
                  />
                  <input
                    type="text"
                    id="card-billing-address-admin-area-line-2-expanded"
                    name="card-billing-address-admin-area-line-2-expanded"
                    autocomplete="off"
                    placeholder="State"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px;"
                  />
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                  <select
                    id="card-billing-address-country-code-expanded"
                    name="card-billing-address-country-code-expanded"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px; background: white;"
                  >
                    <option value="">Select Country</option>
                    <option value="US" selected>United States</option>
                    <option value="CA">Canada</option>
                    <option value="GB">United Kingdom</option>
                    <option value="AU">Australia</option>
                    <option value="DE">Germany</option>
                    <option value="FR">France</option>
                    <option value="IT">Italy</option>
                    <option value="ES">Spain</option>
                    <option value="MX">Mexico</option>
                    <option value="BR">Brazil</option>
                    <option value="JP">Japan</option>
                    <option value="CN">China</option>
                    <option value="IN">India</option>
                    <option value="KR">South Korea</option>
                    <option value="NL">Netherlands</option>
                    <option value="SE">Sweden</option>
                    <option value="NO">Norway</option>
                    <option value="DK">Denmark</option>
                    <option value="FI">Finland</option>
                    <option value="CH">Switzerland</option>
                    <option value="AT">Austria</option>
                    <option value="BE">Belgium</option>
                    <option value="IE">Ireland</option>
                    <option value="NZ">New Zealand</option>
                    <option value="SG">Singapore</option>
                    <option value="HK">Hong Kong</option>
                    <option value="TW">Taiwan</option>
                  </select>
                  <input
                    type="text"
                    id="card-billing-address-postal-code-expanded"
                    name="card-billing-address-postal-code-expanded"
                    autocomplete="off"
                    placeholder="Postal/Zip code"
                    style="width: 100%; padding: 10px; border: 2px solid #e0d5c0; border-radius: 6px; font-size: 14px;"
                  />
                </div>
              </div>
              <div id="card-fields-errors-expanded" role="alert" style="color: #dc3545; margin-top: 8px; font-size: 14px; min-height: 20px;"></div>
              <button class="buy-button" id="card-field-submit-button-expanded" style="width: 100%; margin-top: 16px; display: none;">
                Pay now with Card
              </button>
            </div>

            <!-- Venmo Details (hidden by default) -->
            <div class="payment-details" id="venmo-details" style="display: none;">
              <p style="margin-bottom: 16px; color: #666;">You will be redirected to Venmo to complete your payment.</p>
              <button class="buy-button" id="venmo-button" style="width: 100%; background: #3D95CE;">
                Continue with Venmo
              </button>
            </div>
          </div>
        </div>

        <!-- External checkout iframe (hidden by default) -->
        <iframe
          id="checkoutFrame"
          src=""
          title="PAPO'S Checkout"
        ></iframe>
      </div>
    </section>

    <!-- Shopping Cart Panel -->
    <section id="cartPanel" class="checkout">
      <div class="checkout-header">
        <span>Shopping Cart</span>
        <button class="checkout-close" id="cartCloseBtn"></button>
      </div>
      <div class="checkout-body">
        <div class="checkout-content">
          <div class="checkout-summary">
            <h3>Your Items</h3>
            <div id="cartItems" style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
              <!-- Cart items will be added here -->
              <p id="emptyCartMessage" style="text-align: center; color: #666; padding: 20px;">Your cart is empty</p>
            </div>
            <div class="checkout-item" id="cartTotalRow" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 2px solid rgba(0, 0, 0, 0.1);">
              <span style="font-weight: 700;">Total</span>
              <span id="cartTotal" style="font-weight: 700;">$0.00</span>
            </div>
            <button id="cartCheckoutButton" class="buy-button" style="display: none; margin-top: 20px; width: 100%;">
              Proceed to Checkout
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Why deSnac Modal -->
    <div id="desnacModal" class="desnac-modal">
      <div class="modal-backdrop"></div>
      <div class="desnac-modal-content">
        <button class="modal-close" id="desnacCloseBtn"></button>
        
        <div class="desnac-header">
          <h1>WHY deSnac?</h1>
          <p class="subtitle">Real satiety. Real calm. Real satisfaction.</p>
        </div>

        <div class="desnac-section">
          <h2>⭐ WHY deSnac?</h2>
          <p><strong>Most snacks give you one of two feelings: a quick high... or a quick regret.</strong></p>
          <p>A deSnac is different. It's food designed to fill you in every dimension — <strong>mind, body, and mood</strong> — so you finish eating and actually feel done.</p>
          <p>A deSnac™ isn't about 'guilt-free' or 'clean' or 'better-for-you.'</p>
          <p>It's about something far more human: <strong>real satiety. Real calm. Real satisfaction.</strong> No crash. No cravings. No emotional void.</p>
        </div>

        <div class="desnac-section">
          <h2>✓ What Is a deSnac?</h2>
          <p>A deSnac is a food engineered for <strong>mind-body satiety</strong> — delivering:</p>
          <ul>
            <li>real physiological fullness</li>
            <li>sustained calm energy</li>
            <li>sensory satisfaction</li>
            <li>emotional grounding</li>
          </ul>
          <p>...without the after-effects of modern ultra-processed snacks.</p>
          <p><strong>Think of it as the opposite of empty crunch.</strong></p>
        </div>

        <div class="desnac-section">
          <h2>🌿 The Three Pillars of Satiety</h2>
          <div class="desnac-columns">
            <div class="desnac-column">
              <h3>Body Satiety — True Physical Fullness</h3>
              <p>A deSnac must satisfy the actual stomach, not just the mouth.</p>
              <ul>
                <li>Natural protein + slow carbs (like makhana's protein + fiber)</li>
                <li>Healthy fats that activate fullness hormones (leptin, CCK, PYY)</li>
                <li>Low glycemic load → no blood sugar spike → no rebound hunger</li>
                <li>High nutrient density (magnesium, antioxidants, polyphenols)</li>
              </ul>
              <h3>Functional Targets:</h3>
              <ul>
                <li>3-5g protein per 100 kcal</li>
                <li>2-4g fiber</li>
                <li>≤5g sugar, preferably natural or low glycemic</li>
              </ul>
              <p><strong>→ Your body gets the 'enough' signal.</strong></p>
            </div>

            <div class="desnac-column">
              <h3>Mind Satiety — Psychological Fullness</h3>
              <p>The 'mind stomach' is real — cravings, emotions, reward circuits.</p>
              <p>A deSnac must satisfy the mind by using:</p>
              <ul>
                <li>Complex flavor architecture</li>
                <li>Layered spices + umami depth</li>
                <li>Textural journey (crisp → melt → calm)</li>
                <li>Real aroma: herbs, cocoa, coffee, truffle, cinnamon</li>
                <li>A sense of meaning or ritual — seasonal flavors, origin, story</li>
              </ul>
              <p><strong>→ Your brain feels complete, instead of asking for more.</strong></p>
            </div>

            <div class="desnac-column">
              <h3>Wholeness — System Harmony</h3>
              <p>Food should leave you better, not depleted.</p>
              <p>So a deSnac must:</p>
              <ul>
                <li>Use clean, single-origin ingredients</li>
                <li>Avoid additives (maltodextrin, fake fibers, artificial hits)</li>
                <li>Support digestion and calm instead of causing bloating</li>
                <li>Align with natural energy rhythms — steady, not jittery</li>
              </ul>
              <p><strong>→ You feel grounded, not restless.</strong></p>
            </div>
          </div>
        </div>

        <div class="desnac-section">
          <h2>📋 The 3 Rules of a deSnac (Functional Pillars)</h2>
          <p>Every deSnac follows three core principles that ensure true mind-body satiety.</p>
        </div>

        <div class="triple-satiety-diagram">
          <h2>TRIPLE SATIETY</h2>
          <div class="triple-satiety-triangle">
            <div class="triangle-shape"></div>
            <div class="triangle-label top">CRAVING SATIETY<br/>(Flavor)</div>
            <div class="triangle-label bottom-left">EMOTIONAL SATIETY<br/>(Mood)</div>
            <div class="triangle-label bottom-right">PHYSICAL SATIETY<br/>(Body)</div>
            <div class="triangle-center">PAPO'S<br/>Full at three levels.</div>
          </div>
          <div class="formula">PAPO'S = Full × 3</div>
        </div>
      </div>
    </div>

    <!-- Our Philosophy Modal -->
    <div id="philosophyModal" class="philosophy-modal">
      <div class="modal-backdrop"></div>
      <div class="philosophy-modal-content">
        <button class="modal-close" id="philosophyCloseBtn"></button>
        
        <div class="desnac-header">
          <h1>The PAPO'S Philosophy</h1>
        </div>

        <div class="philosophy-layout">
          <!-- Left Column -->
          <div class="philosophy-column">
            <div class="philosophy-text-block">
              <p><strong>Let's be real—most snacks either talk down to you, or lie to your face.</strong> 'Guilt-free.' 'Superfoods.' 'Mindful indulgence' like you're some sort of lab experiment trying to be optimized.</p>
            </div>

            <div class="philosophy-illustration">
              😊 😔
            </div>

            <div class="philosophy-text-block">
              <p>We're not here to optimize you. We made PAPO'S because we're snackers too—moody, distracted, tired, hopeful, sometimes spicy, sometimes sad snackers. And we wanted something that didn't make us feel worse after—the feeling of 'un-fullness' when you are full.</p>
            </div>

            <div class="philosophy-text-block">
              <p>So we took foxnut—this crisp, weird little puff that happens to be nutrient rich—and gave it actual soul. No sugar bombs. Dust flavors that slap and textures that satisfy your mind stomach.</p>
            </div>
          </div>

          <!-- Middle Column -->
          <div class="philosophy-column">
            <div class="philosophy-section">
              <h2>TRIPLE SATIETY</h2>
              <div class="triple-satiety-triangle">
                <div class="triangle-shape"></div>
                <div class="triangle-label top">CRAVING SATIETY<br/>(Flavor)</div>
                <div class="triangle-label bottom-left">EMOTIONAL SATIETY<br/>(Mood)</div>
                <div class="triangle-label bottom-right">PHYSICAL SATIETY<br/>(Body)</div>
                <div class="triangle-center">PAPO'S<br/>Full at three levels.</div>
              </div>
              <div class="formula">PAPO'S = Full × 3</div>
            </div>

            <div class="philosophy-text-block" style="text-align: center; font-style: italic; color: #8b6f47; font-weight: 600;">
              <p>Triple Satiety feeds your fullness. The Golden Mean feeds your balance.</p>
            </div>

            <div class="philosophy-section">
              <h2>GOLDILOCK'S GOLDEN MEAN</h2>
              <h3>"Not too much. Not too little. Just right."</h3>
              
              <div class="goldilocks-bowls">
                <div class="bowl-container">
                  <div class="bowl too-little">
                    <div class="bowl-content"></div>
                    <div class="bowl-emoji">😞</div>
                  </div>
                  <div class="bowl-label">
                    <strong>Too Little</strong><br/>
                    Unsatisfying<br/>
                    (Bland, weak)
                  </div>
                </div>

                <div class="bowl-container">
                  <div class="bowl just-right">
                    <div class="bowl-content"></div>
                    <div class="bowl-emoji">😊</div>
                  </div>
                  <div class="bowl-label">
                    <strong>Just Right</strong><br/>
                    The Golden Mean<br/>
                    (Balanced, joyful)<br/>
                    <em style="color: #3f8d3a; font-weight: 700;">PAPO'S sits here</em>
                  </div>
                </div>

                <div class="bowl-container">
                  <div class="bowl too-much">
                    <div class="bowl-content"></div>
                    <div class="bowl-emoji">😐</div>
                  </div>
                  <div class="bowl-label">
                    <strong>Too Much</strong><br/>
                    Overloaded<br/>
                    (Sugary, addictive)
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column -->
          <div class="philosophy-column">
            <div class="philosophy-summary">
              <h2>The PAPO'S Philosophy</h2>
              <p>PAPO'S is built on a simple idea: <strong>triple satiety.</strong> Flavor that rewards your senses. Nutrition that nourishes your body. Energy that soothes your mood.</p>
              <p>Then we go one step further — balancing it all through the <strong>Golden Mean</strong>, our way of keeping every bite 'just right': not too heavy, not too hollow, simply whole.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Response Panel -->
  <div id="aiResponsePanel" class="ai-response-panel">
    <div class="ai-response-header">
      <div class="ai-response-title">PAPO'S AI Assistant</div>
      <button class="ai-response-close" id="aiResponseClose">&times;</button>
    </div>
    <div class="ai-response-body">
      <div id="aiResponseContent" class="ai-response-content"></div>
    </div>
  </div>

  <script>
    // ============================================
    // GOOGLE DRIVE CONFIGURATION
    // ============================================
    // To use images from Google Drive:
    // 1. Make your Google Drive folder/files publicly accessible (right-click > Share > Anyone with the link)
    // 2. Get the file ID from the sharing link (the long string between /d/ and /view)
    // 3. Add the file ID to the GOOGLE_DRIVE_FILES object below
    // 4. Set USE_GOOGLE_DRIVE to true
    
    const USE_GOOGLE_DRIVE = false; // Set to true to enable Google Drive images
    
    // Map of local file paths to Google Drive file IDs
    // Format: 'local/path/file.ext': 'GOOGLE_DRIVE_FILE_ID'
    const GOOGLE_DRIVE_FILES = {
      // Token images
      'images/token-granola.png': 'YOUR_FILE_ID_HERE',
      'images/token-jamaican.png': 'YOUR_FILE_ID_HERE',
      'images/token-coffee.png': 'YOUR_FILE_ID_HERE',
      'images/token-zaatar.png': 'YOUR_FILE_ID_HERE',
      'images/token-pumpkin.png': 'YOUR_FILE_ID_HERE',
      'images/token-orange.png': 'YOUR_FILE_ID_HERE',
      'images/token-tomatoeouy.png': 'YOUR_FILE_ID_HERE',
      'images/token-totallynutz.png': 'YOUR_FILE_ID_HERE',
      'images/token-barbecue.png': 'YOUR_FILE_ID_HERE',
      'images/token-bagel.png': 'YOUR_FILE_ID_HERE',
      
      // Product images
      'images/pearlz.png': 'YOUR_FILE_ID_HERE',
      'images/evergreenglow.png': 'YOUR_FILE_ID_HERE',
      
      // Ingredient images
      'images/compass.png': 'YOUR_FILE_ID_HERE',
      'images/coffeebeans.png': 'YOUR_FILE_ID_HERE',
      'images/image of ceo next to sign.png': 'YOUR_FILE_ID_HERE',
      'images/image of ceo in coffee cup.png': 'YOUR_FILE_ID_HERE',
      'images/melonbee.png': 'YOUR_FILE_ID_HERE',
      'images/sesame.png': 'YOUR_FILE_ID_HERE',
      'images/sumac.png': 'YOUR_FILE_ID_HERE',
      'images/oliveoil.png': 'YOUR_FILE_ID_HERE',
      'images/himalayan salt.png': 'YOUR_FILE_ID_HERE',
      'images/foxnuts.png': 'YOUR_FILE_ID_HERE',
      'images/blacktruffle.png': 'YOUR_FILE_ID_HERE',
      'images/sugar.png': 'YOUR_FILE_ID_HERE',
      'images/coconutoil.png': 'YOUR_FILE_ID_HERE',
      'images/vanillabean.png': 'YOUR_FILE_ID_HERE',
      
      // Video files
      'images/granola.mp4': 'YOUR_FILE_ID_HERE',
      'images/coffee.mp4': 'YOUR_FILE_ID_HERE',
      'images/zaatar.mp4': 'YOUR_FILE_ID_HERE',
      'images/candypumpkin.mp4': 'YOUR_FILE_ID_HERE',
      'images/orangemaple.mp4': 'YOUR_FILE_ID_HERE',
      'images/pearlz.mp4': 'YOUR_FILE_ID_HERE',
      'images/pizza.mp4': 'YOUR_FILE_ID_HERE',
      'images/evergreen.mp4': 'YOUR_FILE_ID_HERE',
      'images/totallynutz.mp4': 'YOUR_FILE_ID_HERE',
      'images/barbecue.mp4': 'YOUR_FILE_ID_HERE',
      'images/bagel.mp4': 'YOUR_FILE_ID_HERE',
      
      // Fun facts images
      'images/zaatar fun facts.png': 'YOUR_FILE_ID_HERE',
      'images/Screen Shot 2025-12-27 at 3.50.23 PM.png': 'YOUR_FILE_ID_HERE',
      
      // Placeholder
      'images/token-placeholder.png': 'YOUR_FILE_ID_HERE'
    };
    
    /**
     * Converts a local file path to a Google Drive URL
     * @param {string} localPath - The local file path (e.g., 'images/token-granola.png')
     * @returns {string} - The Google Drive URL or original path if not configured
     */
    function getGoogleDriveUrl(localPath) {
      if (!USE_GOOGLE_DRIVE) {
        return localPath; // Return original path if Google Drive is disabled
      }
      
      const fileId = GOOGLE_DRIVE_FILES[localPath];
      if (!fileId || fileId === 'YOUR_FILE_ID_HERE') {
        console.warn(`Google Drive file ID not configured for: ${localPath}`);
        return localPath; // Fallback to local path
      }
      
      // Determine if it's a video or image
      const isVideo = /\.(mp4|webm|mov)$/i.test(localPath);
      
      if (isVideo) {
        // For videos, use the preview URL
        return `https://drive.google.com/file/d/${fileId}/preview`;
      } else {
        // For images, use the direct view URL
        return `https://drive.google.com/uc?export=view&id=${fileId}`;
      }
    }
    
    /**
     * Updates all image sources and background images in the DOM to use Google Drive URLs
     * This function runs on page load to convert all local image paths
     */
    function updateImagesToGoogleDrive() {
      if (!USE_GOOGLE_DRIVE) {
        return; // Skip if Google Drive is disabled
      }
      
      // Update all img src attributes
      const images = document.querySelectorAll('img[src^="images/"]');
      images.forEach(img => {
        const originalSrc = img.getAttribute('src');
        if (originalSrc && originalSrc.startsWith('images/')) {
          img.src = getGoogleDriveUrl(originalSrc);
        }
      });
      
      // Update all background-image styles in inline style attributes
      const elementsWithBg = document.querySelectorAll('[style*="background-image"]');
      elementsWithBg.forEach(el => {
        const style = el.getAttribute('style');
        if (style && style.includes('url(') && style.includes('images/')) {
          // Extract the URL from the style attribute
          const urlMatch = style.match(/url\(['"]?([^'")]+)['"]?\)/);
          if (urlMatch && urlMatch[1].startsWith('images/')) {
            const newUrl = getGoogleDriveUrl(urlMatch[1]);
            const newStyle = style.replace(urlMatch[0], `url('${newUrl}')`);
            el.setAttribute('style', newStyle);
          }
        }
      });
      
      // Update token elements that have background-image in CSS classes
      // We override the CSS by setting inline styles
      const tokenClasses = [
        'token-granola', 'token-jamaican', 'token-cafe', 'token-zaatar',
        'token-pumpkin', 'token-orange', 'token-pearlz', 'token-tomatoeouy',
        'token-evergreenglow', 'token-totallynutz', 'token-barbecue', 'token-bagel'
      ];
      
      const tokenImageMap = {
        'token-granola': 'images/token-granola.png',
        'token-jamaican': 'images/token-jamaican.png',
        'token-cafe': 'images/token-coffee.png',
        'token-zaatar': 'images/token-zaatar.png',
        'token-pumpkin': 'images/token-pumpkin.png',
        'token-orange': 'images/token-orange.png',
        'token-pearlz': 'images/pearlz.png',
        'token-tomatoeouy': 'images/token-tomatoeouy.png',
        'token-evergreenglow': 'images/evergreenglow.png',
        'token-totallynutz': 'images/token-totallynutz.png',
        'token-barbecue': 'images/token-barbecue.png',
        'token-bagel': 'images/token-bagel.png'
      };
      
      tokenClasses.forEach(className => {
        const elements = document.querySelectorAll(`.${className}`);
        const imagePath = tokenImageMap[className];
        if (imagePath) {
          const googleDriveUrl = getGoogleDriveUrl(imagePath);
          elements.forEach(el => {
            // Override CSS background-image with inline style
            el.style.backgroundImage = `url('${googleDriveUrl}')`;
          });
        }
      });
    }
    
    // ============================================
    // END GOOGLE DRIVE CONFIGURATION
    // ============================================

    // Configure your flavors here.
    // Swap videoUrl with your Pollo / YouTube links
    // and checkoutUrl with Shopify / payment links.

    // Trade Stamp Definitions - Symbolic icons for each flavor
    const TRADE_STAMPS = {
      granola: { icon: '🌾', label: 'Granola' },
      jamaican: { icon: '🔥', label: 'Jamaican' },
      cafe: { icon: '☕', label: 'Café' },
      zaatar: { icon: '🌿', label: 'Za\'atar' },
      pumpkin: { icon: '🎃', label: 'Pumpkin' },
      orange: { icon: '🍊', label: 'Orange' },
      pearlz: { icon: '💎', label: 'Pearlz' },
      tomatoeouy: { icon: '🍅', label: 'Tomato' },
      evergreenglow: { icon: '🌲', label: 'Evergreen' },
      totallynutz: { icon: '🥜', label: 'Nutz' },
      barbecue: { icon: '🍖', label: 'BBQ' },
      bagel: { icon: '🥯', label: 'Bagel' }
    };

    // Flavor completion tracking
    function getCompletedFlavors() {
      const stored = localStorage.getItem('paposCompletedFlavors');
      return stored ? JSON.parse(stored) : [];
    }

    function markFlavorCompleted(flavorKey) {
      const completed = getCompletedFlavors();
      if (!completed.includes(flavorKey)) {
        completed.push(flavorKey);
        localStorage.setItem('paposCompletedFlavors', JSON.stringify(completed));
        updatePassport();
        updateTokenLockIndicators();
        return true; // Newly completed
      }
      return false; // Already completed
    }

    function isFlavorCompleted(flavorKey) {
      return getCompletedFlavors().includes(flavorKey);
    }

    // Initialize and update Passport UI
    function updatePassport() {
      const stampsGrid = document.getElementById('passportStampsGrid');
      const statsNumber = document.getElementById('passportStatsNumber');
      if (!stampsGrid || !statsNumber) return;

      const completed = getCompletedFlavors();
      statsNumber.textContent = completed.length;

      // Clear existing stamps
      stampsGrid.innerHTML = '';

      // Generate stamps for all flavors
      Object.keys(FLAVORS).forEach(flavorKey => {
        const stamp = TRADE_STAMPS[flavorKey];
        if (!stamp) return;

        const isCompleted = completed.includes(flavorKey);
        const stampEl = document.createElement('div');
        stampEl.className = `passport-stamp ${isCompleted ? 'unlocked' : 'locked'}`;
        stampEl.dataset.flavorKey = flavorKey;
        
        if (isCompleted) {
          stampEl.classList.add('animate');
          // Remove animate class after animation completes
          setTimeout(() => stampEl.classList.remove('animate'), 600);
        }

        stampEl.innerHTML = `
          ${!isCompleted ? '<div class="stamp-lock-icon">🔒</div>' : ''}
          <div class="stamp-icon">${stamp.icon}</div>
          <div class="stamp-label">${stamp.label}</div>
        `;

        // Add click handler to view flavor
        stampEl.addEventListener('click', () => {
          if (isCompleted) {
            openModal(flavorKey);
          }
        });

        stampsGrid.appendChild(stampEl);
      });
    }

    const FLAVORS = {
      granola: {
        name: "Granola Cereal Fox-Nut",
        tagline: "Breakfast-in-a-bag coziness.",
        description:
          "Popped lotus seeds tumbled with granola clusters, oats, and a touch of creamy vanilla. Light crunch, big comfort — like the world's friendliest cereal, no bowl required.",
        videoUrl: getGoogleDriveUrl("images/granola.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/granola",
        price: "$15.00",
        funFacts: [
          "Foxnuts (makhana) have been eaten in Asia for over 3,000 years — they were once reserved for royalty and served at imperial banquets.",
          "A single serving contains more protein than a hard-boiled egg, with zero cholesterol and naturally low sodium.",
          "The lotus seeds 'pop' like tiny popcorn when heated, creating an airy texture that's 80% air by volume — making them the lightest snack base on Earth.",
          "Ancient Ayurvedic texts called makhana 'the food of the gods' for its ability to balance all three doshas (body energies).",
          "Our granola clusters are baked at low temperatures to preserve the natural oils and nutrients — most commercial granolas lose 40% of their antioxidants during high-heat processing."
        ]
      },
      jamaican: {
        name: "Jamaican Jungle Flame",
        tagline: "Sunny reggae heat, mellow and warm.",
        description:
          "Inspired by island nights and backyard music. A gentle reggae of spice, smoke, and herbs wrapped around ultra-light foxnuts. Each bite carries the warmth of allspice (pimento), the earthy depth of scotch bonnet peppers, and the smoky whisper of jerk seasoning — a flavor journey that starts bold and finishes smooth, like a perfect island sunset.",
        videoUrl: "COMING_SOON",
        checkoutUrl: "https://yourstore.com/checkout/jamaican",
        price: "$15.00",
        funFacts: [
          "Allspice (pimento) got its name because it tastes like cinnamon, nutmeg, and cloves all at once — but it's actually a single berry from the Pimenta tree, native only to Jamaica.",
          "Scotch bonnet peppers are 40 times hotter than jalapeños, but we use them in micro-doses to add warmth without burn — the capsaicin actually triggers endorphin release for a natural mood boost.",
          "Jerk seasoning was invented by the Maroons (escaped slaves) who preserved meat in the Jamaican mountains using a blend of spices that acted as natural preservatives — the technique is now a UNESCO-recognized cultural heritage.",
          "The 'reggae' in our description isn't just poetic — the rhythm of flavors (spice → smoke → herb → calm) mirrors the syncopated beats of reggae music, creating a multi-layered sensory experience.",
          "Jamaica produces the world's rarest allspice — only 2% of global production comes from the island, and we source ours directly from small farms in the Blue Mountains."
        ]
      },
      cafe: {
        name: "Café Con Crunch",
        tagline: "Coffee break meets snack break.",
        description:
          "Roasted coffee notes, a whisper of sweetness, and a playful crunch that feels like your favorite café… in handful form. We use instant coffee that's been brewed and freeze-dried to capture all 800+ aromatic compounds — then we blend it with just enough natural sweetness to balance the bitterness, creating a snack that satisfies your coffee craving without the jitters.",
        videoUrl: getGoogleDriveUrl("images/coffee.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/cafe",
        price: "$15.00",
        funFacts: [
          "Coffee contains over 800 aromatic compounds — more than wine. When brewed and dried, those aromas stay while volatility disappears, giving us depth without dominance.",
          "The instant coffee we use comes from Kauai Coffee Plantation in Hawaii, where volcanic soil and tropical climate create beans with naturally lower acidity and smoother flavor.",
          "Coffee's bitterness comes from chlorogenic acids, which are actually antioxidants — we balance them with natural sweetness so your brain gets the 'coffee signal' without the harsh edge.",
          "The caffeine in our snack is naturally bound to coffee's other compounds, creating a 'slow-release' effect that provides steady energy instead of a spike-and-crash.",
          "Freeze-drying coffee preserves 95% of its original flavor compounds, compared to spray-drying which loses up to 40% — that's why our coffee flavor tastes like you're drinking a fresh cup, not instant."
        ]
      },
      zaatar: {
        name: "Za'atar",
        tagline: "Herby, lemony, and deeply cozy. A grounded, soulful bite for the inner traveler who longs to taste the world...",
        description:
          "A Mediterranean daydream of thyme, toasted sesame, and citrusy tang hugging every puffed lotus seed. Za'atar's warm, wild herbs melt into the deep, earthy richness of European truffle – a flavor born from sunlit hillsides and old-world kitchens. This isn't just seasoning; it's a 5,000-year-old recipe that's been passed down through generations, now reimagined for modern snacking.",
        videoUrl: getGoogleDriveUrl("images/zaatar.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/zaatar",
        price: "$15.00",
        funFactsImage: getGoogleDriveUrl("images/zaatar fun facts.png")
      },
      pumpkin: {
        name: "Candied Pumpkin",
        tagline: "Pumpkin-patch campfire energy.",
        description:
          "Warm spices, roasted pumpkin vibes, and a gentle sweetness that feels like a hug in October. We use real pumpkin powder (not just flavoring) combined with cinnamon, nutmeg, and a touch of maple — creating a snack that captures the essence of fall without the sugar crash. Each bite is like walking through a pumpkin patch on a crisp autumn morning, with the warmth of a campfire waiting at the end.",
        videoUrl: getGoogleDriveUrl("images/candypumpkin.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/pumpkin",
        price: "$15.00",
        funFactsImage: getGoogleDriveUrl("images/Screen Shot 2025-12-27 at 3.50.23 PM.png"),
        funFacts: [
          "Pumpkins are 90% water, but when dehydrated and powdered, they become a nutrient powerhouse — one serving of our snack contains the beta-carotene equivalent of half a cup of fresh pumpkin.",
          "The 'candied' in our name comes from a traditional technique where pumpkin is slowly cooked with spices until the natural sugars caramelize — we replicate this process using low-temperature dehydration to preserve nutrients.",
          "Pumpkin seeds (pepitas) are one of the few plant sources of complete protein, and we include their oil in our seasoning blend for added richness and satiety.",
          "Cinnamon and nutmeg were once worth more than gold — in the 16th century, a pound of nutmeg could buy a house. We use Ceylon cinnamon (the 'true' variety) which has 250 times less coumarin than the common cassia variety.",
          "The combination of pumpkin, cinnamon, and maple creates a natural serotonin boost — these ingredients contain compounds that support mood and energy, making this the perfect autumn comfort snack."
        ]
      },
      orange: {
        name: "Orange Maple",
        tagline: "Citrus sunrise with maple sunset.",
        description:
          "Bright orange peel, cozy maple, and a crunchy foxnut canvas — like breakfast and dessert high-fiving. We use cold-pressed orange oil (extracted from the peel, not the juice) combined with real maple syrup crystals for a flavor that's both zesty and warm. The orange provides the morning energy, the maple brings the evening comfort — together, they create a snack that works any time of day.",
        videoUrl: getGoogleDriveUrl("images/orangemaple.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/orange",
        price: "$15.00",
        funFacts: [
          "Orange peel contains 10 times more vitamin C and 4 times more fiber than the fruit itself — we use cold-pressed oil from organic peels to capture all those benefits without the bitterness.",
          "Maple syrup is the only sweetener that's also a mineral supplement — it contains 54 beneficial compounds including manganese, zinc, and calcium. Our maple comes from Quebec, where the cold climate creates the richest, most complex flavor.",
          "The 'sunrise/sunset' pairing isn't just poetic — orange's limonene (a natural compound) boosts morning alertness, while maple's natural sugars provide sustained afternoon energy without the crash.",
          "It takes 40 gallons of maple sap to make 1 gallon of syrup — we use the Grade A Dark Amber variety, which has the most robust flavor and highest mineral content.",
          "Orange and maple are a classic French-Canadian combination (think crêpes suzette) — we've taken this elegant pairing and made it snackable, preserving the sophistication while adding portability."
        ]
      },
      pearlz: {
        name: "Pearlz",
        tagline: "Oceanic elegance meets island paradise.",
        description:
          "Inspired by the pristine waters of Tahiti, Pearlz captures the essence of tropical luxury. A delicate blend of sea salt, coconut, and vanilla creates a flavor that's both sophisticated and refreshing. Each bite transports you to a Polynesian beach, where the ocean breeze meets the sweetness of island fruits. This isn't just a snack—it's a taste of paradise, wrapped in the lightest, most airy foxnut crunch.",
        videoUrl: getGoogleDriveUrl("images/pearlz.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/pearlz",
        price: "$15.00",
        funFacts: [
          "Tahitian vanilla is considered the world's finest, with a floral, fruity profile that's completely different from Madagascar vanilla — we source ours directly from small farms in French Polynesia.",
          "Sea salt from the Pacific contains 84 trace minerals, including magnesium and potassium, which enhance flavor while providing natural electrolytes.",
          "Coconut in Tahiti is traditionally harvested by hand-climbing 60-foot palm trees — a skill passed down through generations of Polynesian families.",
          "The name 'Pearlz' honors Tahiti's famous black pearls, which are formed when a grain of sand enters an oyster and is slowly transformed into something beautiful — just like our simple ingredients becoming extraordinary flavor.",
          "Polynesian cuisine emphasizes balance between sweet, salty, and umami — Pearlz captures this ancient wisdom in every bite."
        ]
      },
      tomatoeouy: {
        name: "Tomatoe'ouy",
        tagline: "Mediterranean sunshine in every bite.",
        description:
          "A celebration of Italian summer, where sun-ripened tomatoes meet aromatic herbs and a hint of garlic. Tomatoe'ouy brings the essence of a Tuscan garden to your fingertips. We use real tomato powder from San Marzano tomatoes (the gold standard of Italian cuisine) combined with basil, oregano, and a whisper of garlic. Each bite is like a perfect bruschetta, but in snack form — bright, fresh, and bursting with Mediterranean flavor.",
        videoUrl: getGoogleDriveUrl("images/pizza.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/tomatoeouy",
        price: "$15.00",
        funFacts: [
          "San Marzano tomatoes grow only in the volcanic soil near Mount Vesuvius — the same region that destroyed Pompeii now produces the world's most prized tomatoes.",
          "Tomatoes weren't always red — the original wild tomatoes were yellow, and the name 'pomodoro' (Italian for tomato) means 'golden apple'.",
          "The umami in tomatoes comes from glutamic acid, which is naturally present in high concentrations — this is why tomatoes make everything taste better.",
          "Basil and tomatoes are a perfect pairing because they share terpenes (aromatic compounds) that create a synergistic flavor effect — science meets tradition.",
          "Italian tomatoes are sun-dried using methods dating back 2,000 years — we use this same technique to preserve maximum flavor and nutrients."
        ]
      },
      evergreenglow: {
        name: "Evergreen Glow",
        tagline: "Mountain freshness meets forest depth.",
        description:
          "Inspired by the pristine forests of Idaho, Evergreen Glow captures the essence of pine, cedar, and mountain air. A unique blend of forest botanicals, juniper, and a hint of citrus creates a flavor that's both invigorating and grounding. Each bite is like hiking through an old-growth forest after a rain — fresh, clean, and deeply satisfying. This isn't just a snack; it's a taste of the wilderness, made snackable.",
        videoUrl: getGoogleDriveUrl("images/evergreen.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/evergreenglow",
        price: "$15.00",
        funFacts: [
          "Pine needles contain more vitamin C than oranges — Native Americans used them to prevent scurvy during long winters.",
          "Juniper berries (used in gin) are actually tiny cones, not berries — they take 2-3 years to ripen and are hand-harvested in the wild.",
          "The 'glow' in our name comes from the natural terpenes in evergreens, which have been shown to boost mood and reduce stress — forest bathing in snack form.",
          "Idaho's Sawtooth Mountains are home to some of the oldest trees in North America — we source our botanicals from sustainable wild-harvesting practices.",
          "Cedar has been used for thousands of years for its preservative properties — the same compounds that protect wood also enhance flavor and shelf life naturally."
        ]
      },
      totallynutz: {
        name: "Totally Nutz",
        tagline: "Nutty, toasty, and completely addictive.",
        description:
          "A celebration of all things nutty, where almonds, walnuts, and pecans come together in perfect harmony. Totally Nutz is inspired by the rich agricultural heritage of Georgia, where pecan trees line the streets and nut orchards stretch for miles. We use real nut powders and extracts to create a flavor that's deeply satisfying and naturally rich. Each bite is like a trail mix, but elevated — sophisticated, crunchy, and totally nutz.",
        videoUrl: getGoogleDriveUrl("images/totallynutz.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/totallynutz",
        price: "$15.00",
        funFacts: [
          "Georgia produces more pecans than any other state — the pecan is actually the state tree, and Georgia's climate creates the perfect conditions for nut cultivation.",
          "Almonds are technically seeds, not nuts — they're the seed of a fruit related to peaches and plums, which is why they have that delicate, slightly sweet flavor.",
          "Walnuts contain omega-3 fatty acids in a form that's more easily absorbed than fish oil — just a handful provides your daily requirement.",
          "Pecans are native to North America and were a staple food for Native Americans for thousands of years — they're one of the few tree nuts indigenous to the continent.",
          "The combination of different nuts creates a complete amino acid profile, making Totally Nutz a protein powerhouse disguised as a delicious snack."
        ]
      },
      barbecue: {
        name: "Barbecue",
        tagline: "Smoky, sweet, and Texas-sized flavor.",
        description:
          "Everything's bigger in Texas, including the flavor. Our Barbecue blend captures the essence of slow-smoked brisket, tangy barbecue sauce, and the perfect balance of sweet and smoky. Inspired by the legendary barbecue pits of Texas, we've created a snack that brings the taste of a backyard cookout to your hands. Real smoked paprika, molasses, and a secret blend of spices create a flavor that's bold, satisfying, and unmistakably Texan. Y'all are gonna love this.",
        videoUrl: getGoogleDriveUrl("images/barbecue.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/barbecue",
        price: "$15.00",
        funFacts: [
          "Texas barbecue is so serious that there are entire festivals dedicated to it — the technique of slow-smoking meat over indirect heat dates back to Native American cooking methods.",
          "Smoked paprika gets its flavor from peppers that are smoked and dried over oak fires — the process takes weeks and creates over 200 flavor compounds.",
          "Molasses is what's left after sugar is extracted from sugarcane — it's rich in iron, calcium, and B vitamins, making it both flavorful and nutritious.",
          "The 'low and slow' barbecue method (cooking at low temperatures for hours) creates the Maillard reaction, which produces complex, savory flavors — we replicate this in our seasoning blend.",
          "Texas barbecue sauce is traditionally less sweet and more vinegar-based than other regional styles — our blend captures this tangy, bold character that Texans know and love."
        ]
      },
      bagel: {
        name: "Everything Bagel",
        tagline: "Savory, toasty, and perfectly seasoned.",
        description:
          "The classic New York deli experience, reimagined. Everything Bagel brings together poppy seeds, sesame seeds, garlic, onion, and salt in perfect harmony. Each bite is like biting into the perfect everything bagel — savory, aromatic, and deeply satisfying. We've captured the essence of that iconic New York breakfast staple and made it snackable, so you can enjoy that bold, complex flavor anywhere, anytime.",
        videoUrl: getGoogleDriveUrl("images/bagel.mp4"),
        checkoutUrl: "https://yourstore.com/checkout/bagel",
        price: "$15.00",
        funFacts: [
          "The 'everything' bagel was invented in 1980s New York when a bagel shop owner mixed all the leftover toppings together — what started as a way to reduce waste became an iconic flavor.",
          "Poppy seeds come from the opium poppy plant, but the seeds themselves contain no narcotics — they're completely safe and add a nutty, slightly sweet flavor.",
          "Sesame seeds are one of the oldest oilseed crops known to humanity, dating back over 3,500 years — they were considered a luxury food in ancient civilizations.",
          "The combination of garlic, onion, and salt creates umami (the fifth taste), which makes everything bagel seasoning so addictive and satisfying.",
          "Everything bagel seasoning has become so popular that it's now used on everything from avocado toast to ice cream — but we think it's perfect on our light, airy foxnuts."
        ]
      },
    };

    const modal = document.getElementById("flavorModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalTagline = document.getElementById("modalTagline");
    const modalDescription = document.getElementById("modalDescription");
    const modalVideo = document.getElementById("modalVideo");
    const modalImage = document.getElementById("modalImage");
    const comingSoonText = document.getElementById("comingSoonText");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const notificationPopup = document.getElementById("notificationPopup");
    const notificationMessage = document.getElementById("notificationMessage");
    const notificationCloseBtn = document.getElementById("notificationCloseBtn");

    const checkoutPanel = document.getElementById("checkoutPanel");
    const checkoutFrame = document.getElementById("checkoutFrame");
    const checkoutTitle = document.getElementById("checkoutTitle");
    const checkoutCloseBtn = document.getElementById("checkoutCloseBtn");
    const buyButton = document.getElementById("buyButton");
    const addToCartButton = document.getElementById("addToCartButton");
    const visualizeButton = document.getElementById("visualizeButton");
    const returnButton = document.getElementById("returnButton");

    const cartPanel = document.getElementById("cartPanel");
    const cartCloseBtn = document.getElementById("cartCloseBtn");
    const cartItems = document.getElementById("cartItems");
    const cartTotal = document.getElementById("cartTotal");
    const cartTotalRow = document.getElementById("cartTotalRow");
    const cartCheckoutButton = document.getElementById("cartCheckoutButton");
    const emptyCartMessage = document.getElementById("emptyCartMessage");
    const navbarCart = document.querySelector(".navbar-cart");

    let currentFlavorKey = null;
    let cart = []; // Array to store cart items

    function openModal(flavorKey) {
      const flavor = FLAVORS[flavorKey];
      if (!flavor) return;

      // Mark flavor as completed when modal opens
      const newlyCompleted = markFlavorCompleted(flavorKey);

      currentFlavorKey = flavorKey;
      modalTitle.textContent = flavor.name;
      modalTagline.textContent = flavor.tagline;
      modalDescription.textContent = flavor.description;

      // Hide all media elements first
      modalVideo.style.display = 'none';
      if (modalImage) {
        modalImage.style.display = 'none';
      }
      if (comingSoonText) {
        comingSoonText.style.display = 'none';
      }

      // Check if it's "Coming Soon"
      if (flavor.videoUrl === "COMING_SOON" || !flavor.videoUrl || flavor.videoUrl === "") {
        // Display "Coming Soon!" text
        if (comingSoonText) {
          comingSoonText.style.display = 'flex';
        }
      } else {
        // Check if videoUrl is an image or video
        const isImage = /\.(png|jpg|jpeg|gif|webp)$/i.test(flavor.videoUrl);
        
        if (isImage) {
          // Display as image
          if (modalImage) {
            modalImage.src = flavor.videoUrl;
            modalImage.style.display = 'block';
          }
        } else {
          // Display as video
          modalVideo.style.display = 'block';
    modalVideo.src = flavor.videoUrl;
    modalVideo.autoplay = true; 
          modalVideo.loop = true;
    
    // Add error handling for video
    modalVideo.onerror = function() {
      console.warn('Video failed to load:', flavor.videoUrl);
            // Fallback to "Coming Soon" if video fails
      modalVideo.style.display = 'none';
            if (comingSoonText) {
              comingSoonText.style.display = 'flex';
            }
    };
    
    modalVideo.onloadeddata = function() {
      modalVideo.style.display = 'block';
    };
    
    modalVideo.play().catch(function(error) {
      console.warn('Video autoplay failed:', error);
      // Video will still be visible, just won't autoplay
    });
        }
      }
      
      modal.classList.add("visible");
    }

    function closeModal() {
      modal.classList.remove("visible");
      // Stop video
        modalVideo.pause();
        modalVideo.src = "";
      // Hide image
      if (modalImage) {
        modalImage.style.display = 'none';
        modalImage.src = "";
      }
      // Hide "Coming Soon" text
      if (comingSoonText) {
        comingSoonText.style.display = 'none';
      }
    }

    function openCheckout() {
      if (!currentFlavorKey) return;
      const flavor = FLAVORS[currentFlavorKey];
      
      // Check for special restrictions
      if (currentFlavorKey === 'jamaican' || currentFlavorKey === 'pearlz' || currentFlavorKey === 'totallynutz') {
        showNotification("Coming Soon!");
        return;
      }
      
      if (currentFlavorKey === 'pumpkin') {
        showNotification("Only Available during Halloween");
        return;
      }
      
      checkoutTitle.textContent = "Checkout – " + flavor.name;
      
      // Add item to cart if not already there (for "Buy Now" functionality)
      // Parse price to number (consistent with addToCart function)
      const price = parseFloat(flavor.price?.replace('$', '') || '15.00');
      const existingItemIndex = cart.findIndex(item => item.id === currentFlavorKey);
      
      if (existingItemIndex >= 0) {
        // Item already in cart, just update quantity to 1 for "Buy Now"
        cart[existingItemIndex].quantity = 1;
      } else {
        // Add item to cart
        cart.push({
          id: currentFlavorKey,
          name: flavor.name,
          price: price, // Store as number, not string
          quantity: 1
        });
      }
      
      // Update order summary
      const checkoutItemName = document.getElementById("checkoutItemName");
      const checkoutItemPrice = document.getElementById("checkoutItemPrice");
      const checkoutTotal = document.getElementById("checkoutTotal");
      
      // Format price for display
      const priceDisplay = `$${price.toFixed(2)}`;
      
      if (checkoutItemName) checkoutItemName.textContent = flavor.name;
      if (checkoutItemPrice) checkoutItemPrice.textContent = priceDisplay;
      if (checkoutTotal) checkoutTotal.textContent = priceDisplay;
      
      // Update cart display
      updateCartDisplay();
      
      // Hide iframe, show payment methods
      const checkoutContent = document.querySelector('.checkout-content');
      if (checkoutFrame) {
        checkoutFrame.classList.remove("active");
        checkoutFrame.src = "";
      }
      if (checkoutContent) {
        checkoutContent.style.display = 'flex';
      }
      
      checkoutPanel.classList.add("visible");
    }

    function closeCheckout() {
      checkoutPanel.classList.remove("visible");
      checkoutFrame.src = "";
    }

    // Token click handlers with unlock check
    document.querySelectorAll(".token").forEach((token) => {
      token.addEventListener("click", () => {
        const key = token.dataset.flavorId;
        
        // Check if flavor is unlocked
        // Unlock logic: First flavor is always accessible
        // Other flavors require at least one completed flavor
        const completed = getCompletedFlavors();
        const allFlavorKeys = Object.keys(FLAVORS);
        const currentIndex = allFlavorKeys.indexOf(key);
        
        // Check if this flavor is already completed or if it's the first one
        const isCompleted = isFlavorCompleted(key);
        const isFirstFlavor = currentIndex === 0;
        const hasCompletedAny = completed.length > 0;
        
        // Allow if: already completed, OR it's the first flavor, OR user has completed at least one flavor
        if (isCompleted || isFirstFlavor || hasCompletedAny) {
          openModal(key);
        } else {
          // Show locked message
          const lockedMessage = document.getElementById('tokenLockedMessage');
          if (lockedMessage) {
            lockedMessage.classList.add('visible');
            // Auto-hide after 4 seconds
            setTimeout(() => {
              lockedMessage.classList.remove('visible');
            }, 4000);
          }
        }
      });
    });

    // Close modal
    modalCloseBtn.addEventListener("click", closeModal);
    modal
      .querySelector(".modal-backdrop")
      .addEventListener("click", closeModal);

    // Notification popup functionality
    function showNotification(message) {
      if (!notificationPopup || !notificationMessage) return;
      
      notificationMessage.textContent = message;
      notificationPopup.classList.add("visible");
      
      // Auto-hide after 2.5 seconds
      setTimeout(() => {
        hideNotification();
      }, 2500);
    }

    function hideNotification() {
      if (notificationPopup) {
        notificationPopup.classList.remove("visible");
      }
    }

    // Add to Cart functionality
    function addToCart(flavorKey) {
      const flavor = FLAVORS[flavorKey];
      if (!flavor) return;

      // Check for special restrictions
      if (flavorKey === 'jamaican' || flavorKey === 'pearlz' || flavorKey === 'totallynutz') {
        showNotification("Coming Soon!");
        return;
      }
      
      if (flavorKey === 'pumpkin') {
        showNotification("Only Available during Halloween");
        return;
      }

      const price = parseFloat(flavor.price?.replace('$', '') || '15.00');
      const existingItem = cart.find(item => item.id === flavorKey);

      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({
          id: flavorKey,
          name: flavor.name,
          price: price,
          quantity: 1
        });
      }

      updateCartDisplay();
      // Show a brief confirmation
      if (addToCartButton) {
        const originalText = addToCartButton.textContent;
        addToCartButton.textContent = "Added!";
        addToCartButton.style.background = "#3f8d3a";
        addToCartButton.style.color = "#fdf6e4";
        setTimeout(() => {
          addToCartButton.textContent = originalText;
          addToCartButton.style.background = "#f4e5c1";
          addToCartButton.style.color = "#5a4a3a";
        }, 1000);
      }
    }

    // Helper function to get token image path for a flavor
    function getTokenImagePath(flavorId) {
      const tokenImageMap = {
        granola: 'images/token-granola.png',
        jamaican: 'images/token-jamaican.png',
        cafe: 'images/token-coffee.png',
        zaatar: 'images/token-zaatar.png',
        pumpkin: 'images/token-pumpkin.png',
        orange: 'images/token-orange.png',
        pearlz: 'images/pearlz.png',
        tomatoeouy: 'images/token-tomatoeouy.png',
        evergreenglow: 'images/evergreenglow.png',
        totallynutz: 'images/token-totallynutz.png',
        barbecue: 'images/token-barbecue.png',
        bagel: 'images/token-bagel.png'
      };
      const localPath = tokenImageMap[flavorId] || 'images/token-placeholder.png';
      return getGoogleDriveUrl(localPath);
    }

    function updateCartDisplay() {
      if (!cartItems) return;

      // Clear existing items
      cartItems.innerHTML = '';

      if (cart.length === 0) {
        if (emptyCartMessage) emptyCartMessage.style.display = 'block';
        if (cartTotalRow) cartTotalRow.style.display = 'none';
        if (cartCheckoutButton) cartCheckoutButton.style.display = 'none';
        return;
      }

      if (emptyCartMessage) emptyCartMessage.style.display = 'none';
      if (cartTotalRow) cartTotalRow.style.display = 'flex';
      if (cartCheckoutButton) cartCheckoutButton.style.display = 'block';

      let total = 0;

      cart.forEach((item) => {
        // Parse price string (e.g., "$4.50") to number
        const priceNum = typeof item.price === 'string' 
          ? parseFloat(item.price.replace('$', '')) 
          : item.price;
        const itemTotal = priceNum * item.quantity;
        total += itemTotal;

        const tokenImagePath = getTokenImagePath(item.id);

        const cartItemDiv = document.createElement('div');
        cartItemDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fff; border-radius: 6px; border: 1px solid #e0d5c0;';
        cartItemDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
            <img src="${tokenImagePath}" alt="${item.name}" style="width: 48px; height: 48px; object-fit: cover; border-radius: 50%; flex-shrink: 0;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #5a4a3a; margin-bottom: 4px;">${item.name}</div>
            <div style="font-size: 14px; color: #666;">$${priceNum.toFixed(2)} × ${item.quantity}</div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button class="cart-quantity-btn" data-id="${item.id}" data-action="decrease" style="width: 28px; height: 28px; border: 1px solid #8b6f47; background: #f4e5c1; border-radius: 4px; cursor: pointer; font-weight: bold; color: #5a4a3a; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1;">-</button>
            <span style="font-weight: 600; min-width: 20px; text-align: center;">${item.quantity}</span>
            <button class="cart-quantity-btn" data-id="${item.id}" data-action="increase" style="width: 28px; height: 28px; border: 1px solid #8b6f47; background: #f4e5c1; border-radius: 4px; cursor: pointer; font-weight: bold; color: #5a4a3a; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1;">+</button>
            <span style="font-weight: 700; color: #5a4a3a; min-width: 60px; text-align: right;">$${itemTotal.toFixed(2)}</span>
            <button class="cart-remove-btn" data-id="${item.id}" style="width: 28px; height: 28px; border: 1px solid #8a2a2a; background: #f4e5c1; border-radius: 4px; cursor: pointer; color: #8a2a2a; font-weight: bold; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1;">×</button>
          </div>
        `;
        cartItems.appendChild(cartItemDiv);
      });

      // Update total
      if (cartTotal) {
        cartTotal.textContent = `$${total.toFixed(2)}`;
      }

      // Add event listeners to quantity buttons
      document.querySelectorAll('.cart-quantity-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const itemId = btn.dataset.id;
          const action = btn.dataset.action;
          const item = cart.find(i => i.id === itemId);
          
          if (item) {
            if (action === 'increase') {
              item.quantity += 1;
            } else if (action === 'decrease' && item.quantity > 1) {
              item.quantity -= 1;
            } else if (action === 'decrease' && item.quantity === 1) {
              cart = cart.filter(i => i.id !== itemId);
            }
            updateCartDisplay();
          }
        });
      });

      // Add event listeners to remove buttons
      document.querySelectorAll('.cart-remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const itemId = btn.dataset.id;
          cart = cart.filter(i => i.id !== itemId);
          updateCartDisplay();
        });
      });
    }

    function openCart() {
      updateCartDisplay();
      cartPanel.classList.add("visible");
    }

    function closeCart() {
      cartPanel.classList.remove("visible");
    }

    // Add to Cart button
    if (addToCartButton) {
      addToCartButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (currentFlavorKey) {
          addToCart(currentFlavorKey);
        }
      });
    }

    // Cart icon click
    if (navbarCart) {
      navbarCart.addEventListener("click", (e) => {
        e.preventDefault();
        openCart();
      });
    }

    // Cart close button
    if (cartCloseBtn) {
      cartCloseBtn.addEventListener("click", closeCart);
    }

    // Notification close button
    if (notificationCloseBtn) {
      notificationCloseBtn.addEventListener("click", hideNotification);
    }

    // Cart checkout button
    if (cartCheckoutButton) {
      cartCheckoutButton.addEventListener("click", () => {
        closeCart();
        openCheckout();
      });
    }

    // Buy button
    buyButton.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      openCheckout();
      // Keep modal open so user can see both modal and checkout
    });

    // Checkout close
    checkoutCloseBtn.addEventListener("click", closeCheckout);

    // Why deSnac Modal
    const desnacModal = document.getElementById("desnacModal");
    const desnacCloseBtn = document.getElementById("desnacCloseBtn");
    const whyDesnacLink = document.querySelector('a[href="#why-desnac"]');

    function openDesnacModal() {
      desnacModal.classList.add("visible");
    }

    function closeDesnacModal() {
      desnacModal.classList.remove("visible");
    }

    if (whyDesnacLink) {
      whyDesnacLink.addEventListener("click", (e) => {
        e.preventDefault();
        openDesnacModal();
      });
    }

    if (desnacCloseBtn) {
      desnacCloseBtn.addEventListener("click", closeDesnacModal);
    }

    if (desnacModal) {
      desnacModal.querySelector(".modal-backdrop")?.addEventListener("click", closeDesnacModal);
    }

    // Our Philosophy Modal
    const philosophyModal = document.getElementById("philosophyModal");
    const philosophyCloseBtn = document.getElementById("philosophyCloseBtn");
    const philosophyLink = document.querySelector('a[href="#philosophy"]');

    function openPhilosophyModal() {
      philosophyModal.classList.add("visible");
    }

    function closePhilosophyModal() {
      philosophyModal.classList.remove("visible");
    }

    if (philosophyLink) {
      philosophyLink.addEventListener("click", (e) => {
        e.preventDefault();
        openPhilosophyModal();
      });
    }

    if (philosophyCloseBtn) {
      philosophyCloseBtn.addEventListener("click", closePhilosophyModal);
    }

    if (philosophyModal) {
      philosophyModal.querySelector(".modal-backdrop")?.addEventListener("click", closePhilosophyModal);
    }

    // Payment method selection
    const paymentOptions = document.querySelectorAll('.payment-option');
    const cardDetails = document.getElementById('card-details');
    const paypalDetails = document.getElementById('paypal-details');
    const venmoDetails = document.getElementById('venmo-details');

    if (paymentOptions.length > 0) {
      paymentOptions.forEach((option) => {
        option.addEventListener('click', () => {
          // Remove selected class from all options
          paymentOptions.forEach(opt => opt.classList.remove('selected'));
          // Add selected class to clicked option
          option.classList.add('selected');
          // Check the radio button
          const radio = option.querySelector('input[type="radio"]');
          if (radio) radio.checked = true;

          // Show/hide payment details based on selection
          const paymentType = option.dataset.payment;
          if (cardDetails) {
            cardDetails.style.display = paymentType === 'card' ? 'block' : 'none';
            // Initialize PayPal card fields when card payment is selected
            if (paymentType === 'card') {
              if (typeof paypal !== 'undefined') {
                setTimeout(() => {
                  initializePayPalCardFields();
                }, 100);
              } else {
                // Wait for PayPal SDK to load
                window.addEventListener('load', () => {
                  if (typeof paypal !== 'undefined') {
                    initializePayPalCardFields();
                  }
                });
              }
            }
          }
          if (paypalDetails) {
            paypalDetails.style.display = paymentType === 'paypal' ? 'block' : 'none';
            // Initialize PayPal buttons when PayPal is selected
            if (paymentType === 'paypal') {
              // Reset rendered flag to allow re-initialization
              paypalButtonsRendered = false;
              paypalButtonsRendering = false;
              paypalExpandedCardFieldsInitialized = false;
              // Wait a bit longer for the container to be visible and stable in DOM, then initialize
              setTimeout(() => {
                // Double-check container is visible and in DOM before initializing
                const container = document.getElementById('paypal-button-container');
                if (container && container.isConnected && paypalDetails.style.display !== 'none') {
                  initializePayPalButtons();
                } else {
                  console.warn('PayPal container not ready, retrying...');
                  setTimeout(() => initializePayPalButtons(), 200);
                }
              }, 200);
            }
          }
          if (venmoDetails) venmoDetails.style.display = paymentType === 'venmo' ? 'block' : 'none';
        });
      });
    }

    // PayPal Expanded Checkout - Card Fields Integration
    let paypalCardFields = null;
    let paypalCardFieldsInitialized = false;

    // Initialize PayPal Card Fields
    function initializePayPalCardFields() {
      if (paypalCardFieldsInitialized || typeof paypal === 'undefined') {
        return;
      }

      const cardForm = document.getElementById('paypal-card-form');
      if (!cardForm) return;

      try {
        // Create CardFields instance
        paypalCardFields = paypal.CardFields({
          createOrder: createPayPalOrderCallback,
          onApprove: onPayPalApproveCallback,
          style: {
            input: {
              fontSize: '16px',
              fontFamily: 'system-ui, -apple-system, sans-serif',
              color: '#3e2b18',
            },
            '.invalid': {
              color: '#dc3545',
            },
          },
        });

        // Check if card fields are eligible
        if (paypalCardFields.isEligible()) {
          // Render card fields
          const nameField = paypalCardFields.NameField({
            style: {
              input: { color: '#3e2b18' },
              '.invalid': { color: '#dc3545' }
            },
          });
          nameField.render('#card-name-field-container');

          const numberField = paypalCardFields.NumberField({
            style: {
              input: { color: '#3e2b18' },
            },
          });
          numberField.render('#card-number-field-container');

          const cvvField = paypalCardFields.CVVField({
            style: {
              input: { color: '#3e2b18' },
            },
          });
          cvvField.render('#card-cvv-field-container');

          const expiryField = paypalCardFields.ExpiryField({
            style: {
              input: { color: '#3e2b18' },
            },
          });
          expiryField.render('#card-expiry-field-container');

          // Add submit button listener
          const submitButton = document.getElementById('card-field-submit-button');
          if (submitButton) {
            submitButton.addEventListener('click', () => {
              const errorElement = document.getElementById('card-fields-errors');
              if (errorElement) {
                errorElement.textContent = '';
              }

              if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'Processing...';
              }

              paypalCardFields.submit({
                billingAddress: {
                  addressLine1: document.getElementById('card-billing-address-line-1')?.value || '',
                  addressLine2: document.getElementById('card-billing-address-line-2')?.value || '',
                  adminArea1: document.getElementById('card-billing-address-admin-area-line-1')?.value || '',
                  adminArea2: document.getElementById('card-billing-address-admin-area-line-2')?.value || '',
                  countryCode: document.getElementById('card-billing-address-country-code')?.value || 'US',
                  postalCode: document.getElementById('card-billing-address-postal-code')?.value || '',
                },
              }).then(() => {
                // Submit successful - handled by onApprove
              }).catch((error) => {
                console.error('Card field submit error:', error);
                const errorElement = document.getElementById('card-fields-errors');
                if (errorElement) {
                  errorElement.textContent = error.message || 'Payment failed. Please try again.';
                }
                if (submitButton) {
                  submitButton.disabled = false;
                  submitButton.textContent = 'Pay now with Card';
                }
              });
            });
          }

          paypalCardFieldsInitialized = true;
        } else {
          console.warn('PayPal Card Fields not eligible');
          const cardForm = document.getElementById('paypal-card-form');
          if (cardForm) {
            cardForm.innerHTML = '<p style="color: #dc3545;">Card payment is not available at this time.</p>';
          }
        }
      } catch (error) {
        console.error('Error initializing PayPal Card Fields:', error);
      }
    }

    // PayPal order creation callback (for card fields)
    async function createPayPalOrderCallback() {
      try {
        if (cart.length === 0) {
          throw new Error('Cart is empty');
        }

        const response = await fetch(`${BACKEND_URL}/api/orders`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            cart: cart.map(item => ({
              id: item.id,
              quantity: item.quantity.toString(),
            })),
          }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to create order');
        }

        const orderData = await response.json();
        if (orderData.id) {
          return orderData.id;
        } else {
          const errorDetail = orderData?.details?.[0];
          const errorMessage = errorDetail
            ? `${errorDetail.issue} ${errorDetail.description} (${orderData.debug_id})`
            : JSON.stringify(orderData);
          throw new Error(errorMessage);
        }
      } catch (error) {
        console.error('Error creating PayPal order:', error);
        const errorElement = document.getElementById('card-fields-errors');
        if (errorElement) {
          errorElement.textContent = `Could not initiate PayPal Checkout: ${error.message}`;
        }
        const submitButton = document.getElementById('card-field-submit-button');
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Pay now with Card';
        }
        throw error;
      }
    }

    // PayPal approval callback (shared for buttons and card fields)
    async function onPayPalApproveCallback(data, actions) {
      try {
        // For buttons, we can use actions.order.capture() directly
        // For card fields, we need to call the backend
        let orderData;
        
        if (actions && actions.order) {
          // Called from PayPal buttons
          orderData = await actions.order.capture();
        } else {
          // Called from card fields - use backend
          const response = await fetch(`${BACKEND_URL}/api/orders/${data.orderID}/capture`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          });
          orderData = await response.json();
        }

        const transaction = orderData?.purchase_units?.[0]?.payments?.captures?.[0] ||
          orderData?.purchase_units?.[0]?.payments?.authorizations?.[0];
        const errorDetail = orderData?.details?.[0];

        if (errorDetail || !transaction || transaction.status === "DECLINED") {
          let errorMessage;
          if (transaction) {
            errorMessage = `Transaction ${transaction.status}: ${transaction.id}`;
          } else if (errorDetail) {
            errorMessage = `${errorDetail.description} (${orderData.debug_id})`;
          } else {
            errorMessage = JSON.stringify(orderData);
          }
          throw new Error(errorMessage);
        } else {
          // Payment successful
          alert('Payment successful! Thank you for your order. Transaction ID: ' + transaction.id);
          // Clear cart
          cart = [];
          updateCartDisplay();
          closeCheckout();
        }
      } catch (error) {
        console.error('Payment capture error:', error);
        // Show error in appropriate error element
        const errorElement = document.getElementById('card-fields-errors') || 
                            document.getElementById('card-fields-errors-expanded');
        if (errorElement) {
          errorElement.textContent = `Sorry, your transaction could not be processed: ${error.message}`;
        }
        // Reset submit buttons
        const submitButton = document.getElementById('card-field-submit-button') ||
                            document.getElementById('card-field-submit-button-expanded');
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Pay now with Card';
        }
      }
    }

    // Initialize card fields when card payment is selected
    if (paymentOptions.length > 0) {
      paymentOptions.forEach((option) => {
        option.addEventListener('click', () => {
          const paymentType = option.dataset.payment;
          if (paymentType === 'card') {
            // Initialize PayPal card fields when card payment is selected
            if (typeof paypal !== 'undefined') {
              setTimeout(() => {
                initializePayPalCardFields();
              }, 100);
            } else {
              // Wait for PayPal SDK to load
              window.addEventListener('load', () => {
                if (typeof paypal !== 'undefined') {
                  initializePayPalCardFields();
                }
              });
            }
          }
        });
      });
    }

    // PayPal Integration
    // PayPal Client ID
    const PAYPAL_CLIENT_ID = 'AXAzi9txkuDcg3jPwu8ooaMCG0PWjAy01RAq9_BPznGD4hIdLTqbUJC1djj95cb8m8OVFmTymJaIqc73';
    let paypalButtonsRendered = false;
    let paypalSDKReady = false;
    let paypalButtonsRendering = false; // Guard to prevent multiple simultaneous renders

    // Wait for PayPal SDK to be ready
    function waitForPayPalSDK(callback, maxAttempts = 20, attempt = 0) {
      if (typeof paypal !== 'undefined' && paypal.Buttons) {
        paypalSDKReady = true;
        console.log('PayPal SDK is ready');
        if (callback) callback();
        return true;
      }
      
      if (attempt >= maxAttempts) {
        console.error('PayPal SDK failed to load after', maxAttempts, 'attempts');
        return false;
      }
      
      setTimeout(() => {
        waitForPayPalSDK(callback, maxAttempts, attempt + 1);
      }, 300);
      
      return false;
    }

    // Initialize PayPal SDK readiness check on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        waitForPayPalSDK(() => {
          console.log('PayPal SDK ready, can initialize buttons');
        });
      });
    } else {
      waitForPayPalSDK(() => {
        console.log('PayPal SDK ready, can initialize buttons');
      });
    }

    // Initialize PayPal Standard SDK Buttons
    function initializePayPalButtons() {
      // Prevent multiple simultaneous render attempts
      if (paypalButtonsRendering) {
        console.log('PayPal buttons already rendering, skipping...');
        return;
      }

      const paypalButtonContainer = document.getElementById('paypal-button-container');
      if (!paypalButtonContainer) {
        console.warn('PayPal button container not found');
        return;
      }

      // Verify container is still in the DOM
      if (!paypalButtonContainer.isConnected) {
        console.warn('PayPal button container not in DOM, waiting...');
        setTimeout(() => {
          initializePayPalButtons();
        }, 200);
        return;
      }

      // Check if container is visible
      const paypalDetails = document.getElementById('paypal-details');
      if (paypalDetails && paypalDetails.style.display === 'none') {
        console.warn('PayPal details section is hidden, waiting...');
        return;
      }

      // Check if PayPal SDK is loaded
      if (typeof paypal === 'undefined' || !paypal.Buttons) {
        console.warn('PayPal SDK not loaded yet, waiting...');
        // Wait for SDK to be ready
        waitForPayPalSDK(() => {
          initializePayPalButtons();
        });
        return;
      }

      // Check if already rendered (but allow re-render if container was cleared)
      if (paypalButtonsRendered && paypalButtonContainer.innerHTML.trim() !== '') {
        console.log('PayPal buttons already rendered');
        return;
      }

      console.log('Initializing PayPal buttons...');

      // Set rendering flag
      paypalButtonsRendering = true;

      // Clear container only if it's safe to do so
      if (paypalButtonContainer.isConnected) {
        paypalButtonContainer.innerHTML = '';
      } else {
        paypalButtonsRendering = false;
        return;
      }

      // Calculate total from cart
      const total = cart.reduce((sum, item) => {
        const price = typeof item.price === 'string' 
          ? parseFloat(item.price.replace('$', '')) 
          : item.price;
        return sum + (price * item.quantity);
      }, 0);

      if (total <= 0) {
        paypalButtonContainer.innerHTML = '<p style="color: #dc3545;">Cart is empty</p>';
        return;
      }

      console.log('Cart total:', total, 'Rendering PayPal buttons...');

      // Render PayPal buttons with backend order creation
      paypal.Buttons({
        style: {
          layout: 'vertical',
          color: 'blue',
          shape: 'rect',
          label: 'paypal'
        },
        createOrder: async function(data, actions) {
          // Use backend to create order
          try {
            if (cart.length === 0) {
              throw new Error('Cart is empty');
            }

            const response = await fetch(`${BACKEND_URL}/api/orders`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                cart: cart.map(item => ({
                  id: item.id,
                  quantity: item.quantity.toString(),
                })),
              }),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || 'Failed to create order');
            }

            const orderData = await response.json();
            if (orderData.id) {
              return orderData.id;
            } else {
              const errorDetail = orderData?.details?.[0];
              const errorMessage = errorDetail
                ? `${errorDetail.issue} ${errorDetail.description} (${orderData.debug_id})`
                : JSON.stringify(orderData);
              throw new Error(errorMessage);
            }
          } catch (error) {
            console.error('Error creating PayPal order:', error);
            throw error;
          }
        },
        onApprove: async function(data, actions) {
          try {
            // Use backend to capture order
            const response = await fetch(`${BACKEND_URL}/api/orders/${data.orderID}/capture`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
            });

            const orderData = await response.json();
            const transaction = orderData?.purchase_units?.[0]?.payments?.captures?.[0] ||
              orderData?.purchase_units?.[0]?.payments?.authorizations?.[0];
            const errorDetail = orderData?.details?.[0];

            if (errorDetail || !transaction || transaction.status === "DECLINED") {
              let errorMessage;
              if (transaction) {
                errorMessage = `Transaction ${transaction.status}: ${transaction.id}`;
              } else if (errorDetail) {
                errorMessage = `${errorDetail.description} (${orderData.debug_id})`;
              } else {
                errorMessage = JSON.stringify(orderData);
              }
              throw new Error(errorMessage);
            } else {
              // Payment successful
              alert('Payment successful! Thank you for your order. Transaction ID: ' + transaction.id);
              // Clear cart
              cart = [];
              updateCartDisplay();
              closeCheckout();
            }
          } catch (error) {
            console.error('Payment capture error:', error);
            alert('Sorry, your transaction could not be processed: ' + error.message);
          }
        },
        onError: function(err) {
          console.error('PayPal error:', err);
          alert('An error occurred during payment. Please try again.');
        },
        onCancel: function(data) {
          console.log('Payment cancelled:', data);
        }
      }).render('#paypal-button-container').then(() => {
        console.log('PayPal buttons rendered successfully');
        paypalButtonsRendered = true;
        paypalButtonsRendering = false;
        
        // Also initialize card fields for expanded checkout
        initializePayPalExpandedCardFields();
      }).catch((error) => {
        console.error('Error rendering PayPal buttons:', error);
        paypalButtonsRendering = false;
        const paypalButtonContainer = document.getElementById('paypal-button-container');
        if (paypalButtonContainer && paypalButtonContainer.isConnected) {
          paypalButtonContainer.innerHTML = '<p style="color: #dc3545; padding: 16px;">Error loading PayPal buttons. Please refresh the page or try again.</p>';
        }
      });
    }

    // Initialize PayPal Card Fields for Expanded Checkout (in PayPal section)
    let paypalExpandedCardFields = null;
    let paypalExpandedCardFieldsInitialized = false;

    function initializePayPalExpandedCardFields() {
      if (paypalExpandedCardFieldsInitialized || typeof paypal === 'undefined') {
        return;
      }

      const cardForm = document.getElementById('paypal-card-form-expanded');
      if (!cardForm) return;

      try {
        // Create CardFields instance
        paypalExpandedCardFields = paypal.CardFields({
          createOrder: createPayPalOrderCallback,
          onApprove: onPayPalApproveCallback,
          style: {
            input: {
              fontSize: '16px',
              fontFamily: 'system-ui, -apple-system, sans-serif',
              color: '#3e2b18',
            },
            '.invalid': {
              color: '#dc3545',
            },
          },
        });

        // Check if card fields are eligible
        if (paypalExpandedCardFields.isEligible()) {
          // Show card form
          cardForm.style.display = 'block';
          const submitButton = document.getElementById('card-field-submit-button-expanded');
          if (submitButton) {
            submitButton.style.display = 'block';
          }

          // Render card fields
          const nameField = paypalExpandedCardFields.NameField({
            style: {
              input: { color: '#3e2b18' },
              '.invalid': { color: '#dc3545' }
            },
          });
          nameField.render('#card-name-field-container-expanded');

          const numberField = paypalExpandedCardFields.NumberField({
            style: {
              input: { color: '#3e2b18' },
            },
          });
          numberField.render('#card-number-field-container-expanded');

          const cvvField = paypalExpandedCardFields.CVVField({
            style: {
              input: { color: '#3e2b18' },
            },
          });
          cvvField.render('#card-cvv-field-container-expanded');

          const expiryField = paypalExpandedCardFields.ExpiryField({
            style: {
              input: { color: '#3e2b18' },
            },
          });
          expiryField.render('#card-expiry-field-container-expanded');

          // Add submit button listener
          const submitButtonExpanded = document.getElementById('card-field-submit-button-expanded');
          if (submitButtonExpanded) {
            submitButtonExpanded.addEventListener('click', () => {
              const errorElement = document.getElementById('card-fields-errors-expanded');
              if (errorElement) {
                errorElement.textContent = '';
              }

              if (submitButtonExpanded) {
                submitButtonExpanded.disabled = true;
                submitButtonExpanded.textContent = 'Processing...';
              }

              paypalExpandedCardFields.submit({
                billingAddress: {
                  addressLine1: document.getElementById('card-billing-address-line-1-expanded')?.value || '',
                  addressLine2: document.getElementById('card-billing-address-line-2-expanded')?.value || '',
                  adminArea1: document.getElementById('card-billing-address-admin-area-line-1-expanded')?.value || '',
                  adminArea2: document.getElementById('card-billing-address-admin-area-line-2-expanded')?.value || '',
                  countryCode: document.getElementById('card-billing-address-country-code-expanded')?.value || 'US',
                  postalCode: document.getElementById('card-billing-address-postal-code-expanded')?.value || '',
                },
              }).then(() => {
                // Submit successful - handled by onApprove
              }).catch((error) => {
                console.error('Card field submit error:', error);
                const errorElement = document.getElementById('card-fields-errors-expanded');
                if (errorElement) {
                  errorElement.textContent = error.message || 'Payment failed. Please try again.';
                }
                if (submitButtonExpanded) {
                  submitButtonExpanded.disabled = false;
                  submitButtonExpanded.textContent = 'Pay now with Card';
                }
              });
            });
          }

          paypalExpandedCardFieldsInitialized = true;
        } else {
          // Hide card form if not eligible
          cardForm.style.display = 'none';
          const submitButton = document.getElementById('card-field-submit-button-expanded');
          if (submitButton) {
            submitButton.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error initializing PayPal Expanded Card Fields:', error);
      }
    }

    // Override closeCheckout to reset PayPal buttons and card fields
    const originalCloseCheckoutFunction = closeCheckout;
    window.closeCheckout = function() {
      paypalButtonsRendered = false;
      paypalExpandedCardFieldsInitialized = false;
      paypalCardFieldsInitialized = false;
      const paypalButtonContainer = document.getElementById('paypal-button-container');
      if (paypalButtonContainer) {
        paypalButtonContainer.innerHTML = '';
      }
      if (originalCloseCheckoutFunction) {
        originalCloseCheckoutFunction();
      }
    };

    // PayPal SDK v6 Integration (for advanced features)
    
    // Backend server URL - change this if your server runs on a different port
    const BACKEND_URL = window.location.origin.includes('5501') || window.location.origin.includes('5500') 
      ? 'http://localhost:3000' 
      : '';
    
    let paypalSDKInstance = null;
    let paypalPaymentSession = null;
    let payLaterPaymentSession = null;
    let paypalCreditPaymentSession = null;

    // Check PayPal eligibility (can be called when payment method is selected)
    async function checkPayPalEligibility() {
      if (!paypalSDKInstance) return;
      
      try {
        const paymentMethods = await paypalSDKInstance.findEligibleMethods({
          currencyCode: "USD",
        });

        const paypalButton = document.querySelector("#paypal-pay-button");
        const payLaterButton = document.querySelector("#paypal-paylater-button");
        const creditButton = document.querySelector("#paypal-credit-button");

        if (paymentMethods.isEligible("paypal") && paypalButton) {
          paypalButton.removeAttribute("hidden");
        } else if (paypalButton) {
          paypalButton.setAttribute("hidden", "true");
        }

        if (paymentMethods.isEligible("paylater") && payLaterButton) {
          const details = paymentMethods.getDetails("paylater");
          payLaterButton.productCode = details.productCode;
          payLaterButton.countryCode = details.countryCode;
          payLaterButton.removeAttribute("hidden");
        } else if (payLaterButton) {
          payLaterButton.setAttribute("hidden", "true");
        }

        if (paymentMethods.isEligible("credit") && creditButton) {
          const details = paymentMethods.getDetails("credit");
          creditButton.countryCode = details.countryCode;
          creditButton.removeAttribute("hidden");
        } else if (creditButton) {
          creditButton.setAttribute("hidden", "true");
        }
      } catch (error) {
        console.error("Error checking PayPal eligibility:", error);
      }
    }

    // Initialize PayPal SDK when loaded
    async function onPayPalWebSdkLoaded() {
      try {
        // Get client token from server
        const clientToken = await getBrowserSafeClientToken();
        
        // Create PayPal SDK instance
        paypalSDKInstance = await window.paypal.createInstance({
          clientToken,
          components: ["paypal-payments"],
          pageType: "checkout",
        });

        // Check eligibility for all payment methods
        const paymentMethods = await paypalSDKInstance.findEligibleMethods({
          currencyCode: "USD",
        });

        // Set up PayPal button if eligible
        if (paymentMethods.isEligible("paypal")) {
          setUpPayPalButton(paypalSDKInstance);
        }

        // Set up Pay Later button if eligible
        if (paymentMethods.isEligible("paylater")) {
          const payLaterPaymentMethodDetails = paymentMethods.getDetails("paylater");
          setUpPayLaterButton(paypalSDKInstance, payLaterPaymentMethodDetails);
        }

        // Set up PayPal Credit button if eligible
        if (paymentMethods.isEligible("credit")) {
          const paypalCreditPaymentMethodDetails = paymentMethods.getDetails("credit");
          setUpPayPalCreditButton(paypalSDKInstance, paypalCreditPaymentMethodDetails);
        }
      } catch (error) {
        // Silently fail if backend server is not running - PayPal buttons just won't show
        // Only log to console in development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.warn("PayPal SDK initialization skipped:", error.message);
        }
        // Don't show error to user - PayPal is optional
      }
    }

    // Get client token from server
    // IMPORTANT: This endpoint must be implemented on your backend server.
    // The backend should use PAYPAL_CLIENT_ID and your PayPal secret to generate a client token.
    // Example backend endpoint (Node.js/Express):
    // POST /paypal-api/client-token
    // Uses PayPal API: POST https://api-m.sandbox.paypal.com/v1/oauth2/token
    // Then: POST https://api-m.sandbox.paypal.com/v1/identity/generate-token
    async function getBrowserSafeClientToken() {
      try {
        // Send client ID to backend (backend will use it with secret to generate token)
        const response = await fetch(`${BACKEND_URL}/paypal-api/client-token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            clientId: PAYPAL_CLIENT_ID
          }),
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server error: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        if (!data.clientToken) {
          throw new Error('Invalid response from server: missing clientToken');
        }
        
        return data.clientToken;
      } catch (error) {
        // In production, this must come from your secure server
        throw new Error(`Failed to get PayPal client token: ${error.message}`);
      }
    }

    // Shared payment session options
    const paymentSessionOptions = {
      async onApprove(data) {
        console.log("Payment approved:", data);
        try {
          const orderData = await captureOrder({
            orderId: data.orderId,
          });
          console.log("Payment captured successfully:", orderData);
          
          // Show success message and close checkout
          alert('Payment successful! Thank you for your order.');
          closeCheckout();
          
          // Clear cart
          cart = [];
          updateCartDisplay();
        } catch (error) {
          console.error("Payment capture failed:", error);
          alert('Payment capture failed. Please try again.');
        }
      },
      
      onCancel(data) {
        console.log("Payment cancelled:", data);
      },
      
      onError(error) {
        console.error("Payment error:", error);
        alert('An error occurred during payment. Please try again.');
      },
    };

    // Set up standard PayPal button
    async function setUpPayPalButton(sdkInstance) {
      console.log("Setting up PayPal button...");
      paypalPaymentSession = sdkInstance.createPayPalOneTimePaymentSession(
        paymentSessionOptions,
      );
      const paypalButton = document.querySelector("#paypal-pay-button");
      if (paypalButton) {
        console.log("PayPal button element found, removing hidden attribute");
        paypalButton.removeAttribute("hidden");
        paypalButton.addEventListener("click", async () => {
          try {
            console.log("PayPal button clicked, starting payment...");
            await paypalPaymentSession.start(
              { presentationMode: "auto" },
              createPayPalOrder(),
            );
          } catch (error) {
            console.error("PayPal payment start error:", error);
            alert('Error starting PayPal payment: ' + error.message);
          }
        });
        console.log("PayPal button setup complete");
      } else {
        console.error("PayPal button element not found!");
      }
    }

    // Set up Pay Later button
    async function setUpPayLaterButton(sdkInstance, payLaterPaymentMethodDetails) {
      payLaterPaymentSession = sdkInstance.createPayLaterOneTimePaymentSession(
        paymentSessionOptions
      );
      const { productCode, countryCode } = payLaterPaymentMethodDetails;
      const payLaterButton = document.querySelector("#paypal-paylater-button");
      if (payLaterButton) {
        payLaterButton.productCode = productCode;
        payLaterButton.countryCode = countryCode;
        payLaterButton.removeAttribute("hidden");
        payLaterButton.addEventListener("click", async () => {
          try {
            await payLaterPaymentSession.start(
              { presentationMode: "auto" },
              createPayPalOrder(),
            );
          } catch (error) {
            console.error("Pay Later payment start error:", error);
          }
        });
      }
    }

    // Set up PayPal Credit button
    async function setUpPayPalCreditButton(sdkInstance, paypalCreditPaymentMethodDetails) {
      paypalCreditPaymentSession = sdkInstance.createPayPalCreditOneTimePaymentSession(
        paymentSessionOptions
      );
      const { countryCode } = paypalCreditPaymentMethodDetails;
      const paypalCreditButton = document.querySelector("#paypal-credit-button");
      if (paypalCreditButton) {
        paypalCreditButton.countryCode = countryCode;
        paypalCreditButton.removeAttribute("hidden");
        paypalCreditButton.addEventListener("click", async () => {
          try {
            await paypalCreditPaymentSession.start(
              { presentationMode: "auto" },
              createPayPalOrder(),
            );
          } catch (error) {
            console.error("PayPal Credit payment start error:", error);
          }
        });
      }
    }

    // Create PayPal order
    async function createPayPalOrder() {
      try {
        // Build order payload from cart
        const items = cart.map(item => {
          // Handle both string and number prices
          const price = typeof item.price === 'string' 
            ? parseFloat(item.price.replace("$", "")) 
            : item.price;
          return {
            name: item.name,
            quantity: item.quantity.toString(),
            unit_amount: {
              currency_code: "USD",
              value: price.toFixed(2)
            }
          };
        });

        const itemTotal = cart.reduce((sum, item) => {
          // Handle both string and number prices
          const price = typeof item.price === 'string' 
            ? parseFloat(item.price.replace("$", "")) 
            : item.price;
          return sum + (price * item.quantity);
        }, 0);

        const orderPayload = {
          intent: "CAPTURE",
          purchase_units: [{
            amount: {
              currency_code: "USD",
              value: itemTotal.toFixed(2),
              breakdown: {
                item_total: {
                  currency_code: "USD",
                  value: itemTotal.toFixed(2)
                }
              }
            },
            items: items
          }]
        };

        // Call your server endpoint to create order
        const response = await fetch(`${BACKEND_URL}/paypal-api/checkout/orders/create`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(orderPayload),
        });

        const data = await response.json();
        
        // Return object with orderId (required for v6)
        return { orderId: data.id };
      } catch (error) {
        console.error("Error creating PayPal order:", error);
        throw error;
      }
    }

    // Capture PayPal order
    async function captureOrder({ orderId }) {
      try {
        const response = await fetch(
          `${BACKEND_URL}/paypal-api/checkout/orders/${orderId}/capture`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          },
        );
        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error capturing PayPal order:", error);
        throw error;
      }
    }

    // Venmo button
    const venmoButton = document.getElementById('venmo-button');
    if (venmoButton) {
      venmoButton.addEventListener('click', () => {
        if (currentFlavorKey) {
          const flavor = FLAVORS[currentFlavorKey];
          if (flavor.checkoutUrl) {
            window.open(flavor.checkoutUrl, '_blank');
          }
        }
      });
    }

    // Google Maps initialization and token positioning
    let map;
    let tokenOverlay;
    const tokenElements = [];

    // Initialize map function
    function initMap() {
      // Custom map style - soft, kiddish, cartoon-like aesthetic
      const customMapStyle = [
        {
          featureType: "all",
          elementType: "geometry",
          stylers: [{ color: "#A8D5A8" }] // Softer green for land
        },
        {
          featureType: "water",
          elementType: "geometry",
          stylers: [{ color: "#6BA3D6" }] // Softer medium blue for water
        },
        {
          featureType: "landscape",
          elementType: "geometry",
          stylers: [{ color: "#9FD89F" }] // Softer green for landscape
        },
        {
          featureType: "poi",
          elementType: "labels",
          stylers: [{ visibility: "off" }] // Hide points of interest labels
        },
        {
          featureType: "poi",
          elementType: "geometry",
          stylers: [{ visibility: "off" }] // Hide points of interest
        },
        {
          featureType: "road",
          elementType: "geometry",
          stylers: [{ visibility: "off" }] // Hide roads
        },
        {
          featureType: "road",
          elementType: "labels",
          stylers: [{ visibility: "off" }] // Hide road labels
        },
        {
          featureType: "administrative",
          elementType: "labels.text",
          stylers: [{ visibility: "off" }] // Hide all labels for clean look
        },
        {
          featureType: "administrative",
          elementType: "labels.text.stroke",
          stylers: [{ visibility: "off" }]
        },
        {
          featureType: "administrative.country",
          elementType: "geometry.stroke",
          stylers: [{ color: "#3D5A8F" }, { weight: 1.5 }] // Softer darker blue outline for landmasses
        },
        {
          featureType: "administrative.province",
          elementType: "geometry.stroke",
          stylers: [{ visibility: "off" }] // Hide province borders
        },
        {
          featureType: "administrative.locality",
          elementType: "geometry.stroke",
          stylers: [{ visibility: "off" }] // Hide city borders
        }
      ];

      // Initialize the map
      // Center slightly south to account for the banner at the top (approximately 200px tall)
      // This ensures flavor tokens aren't hidden behind the sign
      map = new google.maps.Map(document.getElementById('world-map'), {
        center: { lat: -10, lng: 0 },
        zoom: 3,
        mapTypeId: 'roadmap',
        styles: customMapStyle,
        disableDefaultUI: false,
        zoomControl: true,
        mapTypeControl: false,
        scaleControl: false,
        streetViewControl: false,
        rotateControl: false,
        fullscreenControl: true
      });

      // Pan to specific location and set zoom (slightly south to avoid banner)
      map.panTo({ lat: -10, lng: 0 });
      map.setZoom(3);

      // Collect all tokens with coordinates
      document.querySelectorAll('.token').forEach((token) => {
        const lat = parseFloat(token.dataset.lat);
        const lng = parseFloat(token.dataset.lng);
        
        if (!isNaN(lat) && !isNaN(lng)) {
          tokenElements.push({
            element: token,
            lat: lat,
            lng: lng
          });
        }
      });

      // Position sea dragon on the map
      const seaDragon = document.getElementById('seaDragon');
      if (seaDragon) {
        const dragonLat = parseFloat(seaDragon.dataset.lat);
        const dragonLng = parseFloat(seaDragon.dataset.lng);
        
        if (!isNaN(dragonLat) && !isNaN(dragonLng)) {
          tokenElements.push({
            element: seaDragon,
            lat: dragonLat,
            lng: dragonLng
          });
        }
      }

      // Create overlay to position tokens
      tokenOverlay = new google.maps.OverlayView();
      tokenOverlay.onAdd = function() {
        updateTokenPositions();
        mapReadyForShip = true; // Map is ready for ship tracking
      };
      tokenOverlay.draw = function() {
        updateTokenPositions();
      };
      tokenOverlay.onRemove = function() {};
      tokenOverlay.setMap(map);

      // Update positions when map changes
      function updateTokenPositions() {
        if (!tokenOverlay.getProjection()) return;
        
        const projection = tokenOverlay.getProjection();
        const mapDiv = document.getElementById('world-map');
        const mapRect = mapDiv.getBoundingClientRect();
        
        tokenElements.forEach((tokenData) => {
          const latLng = new google.maps.LatLng(tokenData.lat, tokenData.lng);
          const point = projection.fromLatLngToContainerPixel(latLng);
          
          if (point) {
            // Convert container pixel to viewport pixel (map is fixed, so add map's offset)
            const viewportX = mapRect.left + point.x;
            const viewportY = mapRect.top + point.y;
            
            // Center the element based on its type
            if (tokenData.element.id === 'seaDragon') {
              // Center the sea dragon (200px / 2 = 100px width, 120px / 2 = 60px height)
              tokenData.element.style.left = (viewportX - 100) + 'px';
              tokenData.element.style.top = (viewportY - 60) + 'px';
            } else {
            // Center the token (90px / 2 = 45px)
            tokenData.element.style.left = (viewportX - 45) + 'px';
            tokenData.element.style.top = (viewportY - 45) + 'px';
            }
          }
        });
      }

      // Listen to map events to update positions
      google.maps.event.addListener(map, 'bounds_changed', () => {
        updateTokenPositions();
        if (isVisualizationMode) {
          updateIngredientPositions();
        }
      });
      google.maps.event.addListener(map, 'zoom_changed', () => {
        updateTokenPositions();
        if (isVisualizationMode) {
          updateIngredientPositions();
        }
      });
      google.maps.event.addListener(map, 'center_changed', () => {
        updateTokenPositions();
        if (isVisualizationMode) {
          updateIngredientPositions();
        }
      });
    }

    // Ingredient Visualization
    let ingredientElements = [];
    let isVisualizationMode = false;
    let previousFlavorKey = null; // Store which flavor was open before visualization

    function updateIngredientPositions() {
      if (!map || !tokenOverlay || !tokenOverlay.getProjection()) return;
      
      const projection = tokenOverlay.getProjection();
      const mapDiv = document.getElementById('world-map');
      const mapRect = mapDiv.getBoundingClientRect();
      
      ingredientElements.forEach((ingredientData) => {
        const latLng = new google.maps.LatLng(ingredientData.lat, ingredientData.lng);
        const point = projection.fromLatLngToContainerPixel(latLng);
        
        if (point) {
          const viewportX = mapRect.left + point.x;
          const viewportY = mapRect.top + point.y;
          
          ingredientData.element.style.left = (viewportX - 40) + 'px';
          ingredientData.element.style.top = (viewportY - 40) + 'px';
        }
      });
    }

    function showIngredientVisualization() {
      if (currentFlavorKey !== 'cafe' && currentFlavorKey !== 'zaatar') {
        alert('Ingredient visualization is currently only available for Café Con Crunch and Za\'atar.');
        return;
      }

      // Store the current flavor before closing modal
      previousFlavorKey = currentFlavorKey;

      isVisualizationMode = true;
      document.body.classList.add('visualization-mode');
      
      // Update ingredient title based on flavor
      const ingredientTitle = document.getElementById('ingredientTitle');
      if (ingredientTitle && FLAVORS[currentFlavorKey]) {
        ingredientTitle.textContent = FLAVORS[currentFlavorKey].name.toUpperCase() + ' INGREDIENTS';
      }
      
      // Close modal
      closeModal();
      
      // Collect ingredient markers based on flavor
      ingredientElements = [];
      const ingredientIds = currentFlavorKey === 'cafe' 
        ? ['ingredient-coffee', 'ingredient-sugar', 'ingredient-salt', 'ingredient-foxnuts', 'ingredient-coconut', 'ingredient-vanilla']
        : currentFlavorKey === 'zaatar'
        ? ['ingredient-sesame', 'ingredient-sumac', 'ingredient-oliveoil', 'ingredient-salt', 'ingredient-foxnuts', 'ingredient-blacktruffle']
        : [];
      
      ingredientIds.forEach((id) => {
        const marker = document.getElementById(id);
        if (marker) {
          const lat = parseFloat(marker.dataset.lat);
          const lng = parseFloat(marker.dataset.lng);
          
          if (!isNaN(lat) && !isNaN(lng)) {
            marker.style.display = 'block';
            ingredientElements.push({
              element: marker,
              lat: lat,
              lng: lng
            });
          }
        }
      });

      // Update ingredient positions
      if (map && tokenOverlay) {
        updateIngredientPositions();
        // Also update when map changes
        google.maps.event.addListenerOnce(map, 'idle', () => {
          updateIngredientPositions();
        });
      }

      // Pan map to show ingredients better (center on ingredients)
      if (map && ingredientElements.length > 0) {
        const bounds = new google.maps.LatLngBounds();
        ingredientElements.forEach(ing => {
          bounds.extend(new google.maps.LatLng(ing.lat, ing.lng));
        });
        // Also include coffee map elements in bounds if visible
        if (currentFlavorKey === 'cafe' && coffeeMapElements.length > 0) {
          coffeeMapElements.forEach(coffeeEl => {
            bounds.extend(new google.maps.LatLng(coffeeEl.lat, coffeeEl.lng));
          });
        }
        map.fitBounds(bounds);
      }
    }

    function hideIngredientVisualization() {
      isVisualizationMode = false;
      document.body.classList.remove('visualization-mode');
      
      // Hide all ingredient markers
      document.querySelectorAll('.ingredient-marker').forEach((marker) => {
        marker.style.display = 'none';
      });
      
      ingredientElements = [];
      
      // Reset map view (slightly south to avoid banner)
      if (map) {
        map.setCenter({ lat: -10, lng: 0 });
        map.setZoom(3);
      }

      // Reopen the flavor modal that was open before visualization
      if (previousFlavorKey) {
        openModal(previousFlavorKey);
        previousFlavorKey = null; // Reset after reopening
      }
    }

    // Visualize button event listener
    if (visualizeButton) {
      visualizeButton.addEventListener('click', (e) => {
        e.stopPropagation();
        showIngredientVisualization();
      });
    }

    // Return button event listener
    if (returnButton) {
      returnButton.addEventListener('click', () => {
        hideIngredientVisualization();
      });
    }

    // Coffee popup functionality
    const coffeeMarker = document.getElementById('ingredient-coffee');
    const coffeePopup = document.getElementById('coffee-popup');

    if (coffeeMarker && coffeePopup) {
      // Ensure popup is hidden by default
      coffeePopup.style.display = 'none';
      coffeePopup.classList.remove('visible');
      
      let coffeeTimeout;

      coffeeMarker.addEventListener('mouseenter', () => {
        clearTimeout(coffeeTimeout);
        // Position popup near the marker
        const rect = coffeeMarker.getBoundingClientRect();
        
        // Show popup first (hidden) to get its actual dimensions
        coffeePopup.style.visibility = 'hidden';
        coffeePopup.style.display = 'block';
        coffeePopup.classList.add('visible');
        
        const popupMeasured = coffeePopup.getBoundingClientRect();
        const popupWidth = popupMeasured.width;
        const popupHeight = popupMeasured.height;
        
        // Calculate available space
        const spaceRight = window.innerWidth - rect.right;
        const spaceLeft = rect.left;
        const spaceBelow = window.innerHeight - rect.bottom;
        const spaceAbove = rect.top;
        
        let left, top;
        
        // Position horizontally - prefer right, fallback to left, then center
        if (spaceRight >= popupWidth + 20) {
          left = rect.right + 20;
        } else if (spaceLeft >= popupWidth + 20) {
          left = rect.left - popupWidth - 20;
        } else {
          // Center horizontally if neither side has enough space
          left = Math.max(20, (window.innerWidth - popupWidth) / 2);
        }
        
        // Position vertically - prefer below, fallback to above, then center
        if (spaceBelow >= popupHeight + 20) {
          top = rect.bottom + 20;
        } else if (spaceAbove >= popupHeight + 20) {
          top = rect.top - popupHeight - 20;
        } else {
          // Center vertically if neither side has enough space
          top = Math.max(20, (window.innerHeight - popupHeight) / 2);
        }
        
        // Final bounds check to ensure popup stays within viewport
        left = Math.max(20, Math.min(left, window.innerWidth - popupWidth - 20));
        top = Math.max(20, Math.min(top, window.innerHeight - popupHeight - 20));
        
        coffeePopup.style.left = left + 'px';
        coffeePopup.style.top = top + 'px';
        coffeePopup.style.visibility = 'visible';
      });

      coffeeMarker.addEventListener('mouseleave', () => {
        coffeeTimeout = setTimeout(() => {
          coffeePopup.style.display = 'none';
          coffeePopup.classList.remove('visible');
        }, 200);
      });

      coffeePopup.addEventListener('mouseenter', () => {
        clearTimeout(coffeeTimeout);
      });

      coffeePopup.addEventListener('mouseleave', () => {
        coffeePopup.style.display = 'none';
        coffeePopup.classList.remove('visible');
      });
    }

    // Vanilla popup functionality
    const vanillaMarker = document.getElementById('ingredient-vanilla');
    const vanillaPopup = document.getElementById('vanilla-popup');

    if (vanillaMarker && vanillaPopup) {
      // Ensure popup is hidden by default
      vanillaPopup.style.display = 'none';
      vanillaPopup.classList.remove('visible');
      
      let vanillaTimeout;

      vanillaMarker.addEventListener('mouseenter', () => {
        clearTimeout(vanillaTimeout);
        // Position popup near the marker
        const rect = vanillaMarker.getBoundingClientRect();
        
        // Show popup first (hidden) to get its actual dimensions
        vanillaPopup.style.visibility = 'hidden';
        vanillaPopup.style.display = 'block';
        vanillaPopup.classList.add('visible');
        
        const popupMeasured = vanillaPopup.getBoundingClientRect();
        const popupWidth = popupMeasured.width;
        const popupHeight = popupMeasured.height;
        
        // Calculate available space
        const spaceRight = window.innerWidth - rect.right;
        const spaceLeft = rect.left;
        const spaceBelow = window.innerHeight - rect.bottom;
        const spaceAbove = rect.top;
        
        let left, top;
        
        // Position horizontally - prefer right, fallback to left, then center
        if (spaceRight >= popupWidth + 20) {
          left = rect.right + 20;
        } else if (spaceLeft >= popupWidth + 20) {
          left = rect.left - popupWidth - 20;
        } else {
          // Center horizontally if neither side has enough space
          left = Math.max(20, (window.innerWidth - popupWidth) / 2);
        }
        
        // Position vertically - prefer below, fallback to above, then center
        if (spaceBelow >= popupHeight + 20) {
          top = rect.bottom + 20;
        } else if (spaceAbove >= popupHeight + 20) {
          top = rect.top - popupHeight - 20;
        } else {
          // Center vertically if neither side has enough space
          top = Math.max(20, (window.innerHeight - popupHeight) / 2);
        }
        
        // Final bounds check to ensure popup stays within viewport
        left = Math.max(20, Math.min(left, window.innerWidth - popupWidth - 20));
        top = Math.max(20, Math.min(top, window.innerHeight - popupHeight - 20));
        
        vanillaPopup.style.left = left + 'px';
        vanillaPopup.style.top = top + 'px';
        vanillaPopup.style.visibility = 'visible';
      });

      vanillaMarker.addEventListener('mouseleave', () => {
        vanillaTimeout = setTimeout(() => {
          vanillaPopup.style.display = 'none';
          vanillaPopup.classList.remove('visible');
        }, 200);
      });

      vanillaPopup.addEventListener('mouseenter', () => {
        clearTimeout(vanillaTimeout);
      });

      vanillaPopup.addEventListener('mouseleave', () => {
        vanillaPopup.style.display = 'none';
        vanillaPopup.classList.remove('visible');
      });
    }

    // Helper function to setup ingredient popup hover functionality
    function setupIngredientPopup(markerId, popupId) {
      const marker = document.getElementById(markerId);
      const popup = document.getElementById(popupId);

      if (marker && popup) {
        // Ensure popup is hidden by default
        popup.style.display = 'none';
        popup.classList.remove('visible');
        
        let popupTimeout;

        marker.addEventListener('mouseenter', () => {
          clearTimeout(popupTimeout);
          // Position popup near the marker
          const rect = marker.getBoundingClientRect();
          
          // Show popup first (hidden) to get its actual dimensions
          popup.style.visibility = 'hidden';
          popup.style.display = 'block';
          popup.classList.add('visible');
          
          const popupMeasured = popup.getBoundingClientRect();
          const actualWidth = Math.min(popupMeasured.width, window.innerWidth - 40);
          const actualHeight = Math.min(popupMeasured.height, window.innerHeight - 40);
          
          // Calculate available space
          const spaceRight = window.innerWidth - rect.right;
          const spaceLeft = rect.left;
          const spaceBelow = window.innerHeight - rect.bottom;
          const spaceAbove = rect.top;
          
          let left, top;
          
          // Position horizontally - prefer right, fallback to left, then center
          if (spaceRight >= actualWidth + 20) {
            left = rect.right + 20;
          } else if (spaceLeft >= actualWidth + 20) {
            left = rect.left - actualWidth - 20;
          } else {
            // Center horizontally if neither side has enough space
            left = Math.max(20, (window.innerWidth - actualWidth) / 2);
          }
          
          // Position vertically - prefer below, fallback to above, then center
          if (spaceBelow >= actualHeight + 20) {
            top = rect.bottom + 20;
          } else if (spaceAbove >= actualHeight + 20) {
            top = rect.top - actualHeight - 20;
          } else {
            // Center vertically if neither side has enough space
            top = Math.max(20, (window.innerHeight - actualHeight) / 2);
          }
          
          // Final bounds check to ensure popup stays within viewport
          left = Math.max(20, Math.min(left, window.innerWidth - actualWidth - 20));
          top = Math.max(20, Math.min(top, window.innerHeight - actualHeight - 20));
          
          popup.style.left = left + 'px';
          popup.style.top = top + 'px';
          popup.style.maxHeight = actualHeight + 'px';
          popup.style.visibility = 'visible';
        });

        marker.addEventListener('mouseleave', () => {
          popupTimeout = setTimeout(() => {
            popup.style.display = 'none';
            popup.classList.remove('visible');
          }, 200);
        });

        popup.addEventListener('mouseenter', () => {
          clearTimeout(popupTimeout);
        });

        popup.addEventListener('mouseleave', () => {
          popup.style.display = 'none';
          popup.classList.remove('visible');
        });
      }
    }

    // Setup popups for all Za'atar ingredients
    setupIngredientPopup('ingredient-sesame', 'sesame-popup');
    setupIngredientPopup('ingredient-sumac', 'sumac-popup');
    setupIngredientPopup('ingredient-oliveoil', 'oliveoil-popup');
    setupIngredientPopup('ingredient-salt', 'salt-popup');
    setupIngredientPopup('ingredient-foxnuts', 'foxnuts-popup');
    setupIngredientPopup('ingredient-blacktruffle', 'blacktruffle-popup');

    // Fun Facts functionality
    const funFactsButton = document.getElementById('funFactsButton');
    const funFactsModal = document.getElementById('funFactsModal');
    const funFactsCloseBtn = document.getElementById('funFactsCloseBtn');
    const funFactsTitle = document.getElementById('funFactsTitle');
    const funFactsContent = document.getElementById('funFactsContent');

    function openFunFactsModal() {
      if (!currentFlavorKey) return;
      
      const flavor = FLAVORS[currentFlavorKey];
      if (!flavor || (!flavor.funFacts && !flavor.funFactsImage)) {
        alert('Fun facts are not available for this flavor yet.');
        return;
      }

      // Set title
      funFactsTitle.textContent = `${flavor.name} - Fun Facts`;

      // Clear and populate content
      funFactsContent.innerHTML = '';
      
      // If there's an image, display it
      if (flavor.funFactsImage) {
        const imageElement = document.createElement('img');
        imageElement.src = flavor.funFactsImage;
        imageElement.alt = `${flavor.name} Fun Facts`;
        imageElement.className = 'fun-facts-image';
        funFactsContent.appendChild(imageElement);
      } else if (flavor.funFacts) {
        // Otherwise, display text-based fun facts
        flavor.funFacts.forEach((fact, index) => {
          const factItem = document.createElement('div');
          factItem.className = 'fun-fact-item';
          factItem.innerHTML = `
            <div class="fun-fact-number">${index + 1}</div>
            <div class="fun-fact-text">${fact}</div>
          `;
          funFactsContent.appendChild(factItem);
        });
      }

      funFactsModal.classList.add('visible');
    }

    function closeFunFactsModal() {
      funFactsModal.classList.remove('visible');
    }

    if (funFactsButton) {
      funFactsButton.addEventListener('click', (e) => {
        e.stopPropagation();
        openFunFactsModal();
      });
    }

    if (funFactsCloseBtn) {
      funFactsCloseBtn.addEventListener('click', closeFunFactsModal);
    }

    if (funFactsModal) {
      funFactsModal.querySelector('.modal-backdrop')?.addEventListener('click', closeFunFactsModal);
    }

    // Initialize map when both DOM and Google Maps API are ready
    function initializeMapWhenReady() {
      if (typeof google !== 'undefined' && google.maps && document.getElementById('world-map')) {
        initMap();
      } else {
        // Try again after a short delay
        setTimeout(initializeMapWhenReady, 100);
      }
    }

    // Start checking when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeMapWhenReady);
      document.addEventListener('DOMContentLoaded', () => {
        updatePassport();
        updateTokenLockIndicators();
      });
    } else {
      initializeMapWhenReady();
      updatePassport();
      updateTokenLockIndicators();
    }

    // Update token lock indicators based on completion status
    function updateTokenLockIndicators() {
      document.querySelectorAll('.token').forEach((token) => {
        const flavorKey = token.dataset.flavorId;
        if (flavorKey && !isFlavorCompleted(flavorKey)) {
          token.classList.add('locked');
        } else {
          token.classList.remove('locked');
        }
      });
    }

    // Cursor Ship/Footprint Tracking
    const cursorShip = document.getElementById('cursorShip');
    const cursorCaravan = document.getElementById('cursorCaravan');
    const footprintTrailContainer = document.getElementById('footprintTrailContainer');
    let shipX = 0;
    let shipY = 0;
    let caravanX = 0;
    let caravanY = 0;
    let targetX = 0;
    let targetY = 0;
    let isMouseOverMap = false;
    let shipIsOverWater = false;
    let isOverNorthAmerica = false;
    let parkedX = 0;
    let parkedY = 0;
    let parkedAngle = 0;
    let mapReadyForShip = false;
    let lastFootprintX = 0;
    let lastFootprintY = 0;
    let footprintDistance = 0;
    const FOOTPRINT_SPACING = 25; // Minimum distance between footprints

    // Function to check if coordinates are in North America
    function checkIfInNorthAmerica(lat, lng) {
      // North America boundaries
      const northAmerica = { minLat: 25, maxLat: 72, minLng: -170, maxLng: -50 };
      return lat >= northAmerica.minLat && lat <= northAmerica.maxLat &&
             lng >= northAmerica.minLng && lng <= northAmerica.maxLng;
    }

    // Function to check if coordinates are over water
    // Simplified: assume water unless clearly on a major landmass
    function checkIfOverWater(lat, lng) {
      if (!map || !tokenOverlay || !tokenOverlay.getProjection()) {
        return true; // Default to water if map not ready
      }

      // Major landmass exclusion zones (simplified but more accurate)
      const landExclusions = [
        // North America (more precise)
        { minLat: 25, maxLat: 72, minLng: -170, maxLng: -50 },
        // South America
        { minLat: -56, maxLat: 12, minLng: -82, maxLng: -35 },
        // Europe
        { minLat: 35, maxLat: 72, minLng: -10, maxLng: 40 },
        // Africa
        { minLat: -35, maxLat: 37, minLng: -18, maxLng: 52 },
        // Asia (excluding islands)
        { minLat: 10, maxLat: 75, minLng: 40, maxLng: 140 },
        // Australia
        { minLat: -44, maxLat: -10, minLng: 113, maxLng: 154 },
        // Greenland
        { minLat: 60, maxLat: 84, minLng: -75, maxLng: -10 },
        // Large islands
        // Japan
        { minLat: 30, maxLat: 46, minLng: 129, maxLng: 146 },
        // UK/Ireland
        { minLat: 50, maxLat: 61, minLng: -11, maxLng: 2 },
        // Indonesia (main islands)
        { minLat: -11, maxLat: 6, minLng: 95, maxLng: 141 },
        // Philippines
        { minLat: 5, maxLat: 21, minLng: 116, maxLng: 127 },
        // New Zealand
        { minLat: -47, maxLat: -34, minLng: 166, maxLng: 179 },
        // Madagascar
        { minLat: -26, maxLat: -12, minLng: 43, maxLng: 51 },
        // Iceland
        { minLat: 63, maxLat: 67, minLng: -25, maxLng: -13 }
      ];

      // Check if point is in any land exclusion
      for (const land of landExclusions) {
        if (lat >= land.minLat && lat <= land.maxLat &&
            lng >= land.minLng && lng <= land.maxLng) {
          return false; // On land
        }
      }

      // If not in any land exclusion, assume it's water
      return true;
    }

    function updateShipPosition() {
      if (!cursorShip && !cursorCaravan && !footprintTrailContainer) {
        return;
      }
      
      try {
        if (mapReadyForShip && map && tokenOverlay && tokenOverlay.getProjection() && isMouseOverMap) {
          if (shipIsOverWater) {
            // Show ship, hide caravan and clear footprints
            if (cursorShip) {
              cursorShip.classList.add('visible');
            }
            if (cursorCaravan) {
              cursorCaravan.classList.remove('visible');
            }
            if (footprintTrailContainer) {
              footprintTrailContainer.innerHTML = '';
            }
            lastFootprintX = 0;
            lastFootprintY = 0;
            footprintDistance = 0;
            
            // Smooth interpolation for ship movement over water
            shipX += (targetX - shipX) * 0.15;
            shipY += (targetY - shipY) * 0.15;
            
            // Update parked position while moving
            parkedX = shipX;
            parkedY = shipY;
            
            // Calculate rotation based on movement direction
            const dx = targetX - shipX;
            const dy = targetY - shipY;
            const angle = Math.atan2(dy, dx) * (180 / Math.PI);
            parkedAngle = angle;
            
            // Position ship slightly offset from cursor (behind cursor)
            if (cursorShip) {
              cursorShip.style.left = (shipX - 40) + 'px';
              cursorShip.style.top = (shipY - 30) + 'px';
              cursorShip.style.transform = `rotate(${angle}deg)`;
            }
          } else if (isOverNorthAmerica) {
            // Show caravan, hide ship and clear footprints
            if (cursorShip) {
              cursorShip.classList.remove('visible');
            }
            if (cursorCaravan) {
              cursorCaravan.classList.add('visible');
            }
            if (footprintTrailContainer) {
              footprintTrailContainer.innerHTML = '';
            }
            lastFootprintX = 0;
            lastFootprintY = 0;
            footprintDistance = 0;
            
            // Smooth interpolation for caravan movement
            caravanX += (targetX - caravanX) * 0.15;
            caravanY += (targetY - caravanY) * 0.15;
            
            // Calculate rotation based on movement direction
            const dx = targetX - caravanX;
            const dy = targetY - caravanY;
            const angle = Math.atan2(dy, dx) * (180 / Math.PI);
            
            // Position caravan slightly offset from cursor (behind cursor)
            if (cursorCaravan) {
              cursorCaravan.style.left = (caravanX - 45) + 'px';
              cursorCaravan.style.top = (caravanY - 30) + 'px';
              cursorCaravan.style.transform = `rotate(${angle}deg)`;
            }
          } else {
            // Hide ship and caravan, show footprint trail (other land)
            if (cursorShip) {
              cursorShip.classList.remove('visible');
            }
            if (cursorCaravan) {
              cursorCaravan.classList.remove('visible');
            }
            
            // Create footprints as cursor moves
            if (footprintTrailContainer) {
              const dx = targetX - lastFootprintX;
              const dy = targetY - lastFootprintY;
              const distance = Math.sqrt(dx * dx + dy * dy);
              footprintDistance += distance;
              
              // Create new footprint if moved enough distance
              if (footprintDistance >= FOOTPRINT_SPACING || lastFootprintX === 0) {
                createFootprint(targetX, targetY);
                lastFootprintX = targetX;
                lastFootprintY = targetY;
                footprintDistance = 0;
              }
            }
          }
        } else {
          // Hide ship, caravan and clear footprints if map not ready or not over map
          if (cursorShip) {
            cursorShip.classList.remove('visible');
          }
          if (cursorCaravan) {
            cursorCaravan.classList.remove('visible');
          }
          if (footprintTrailContainer) {
            footprintTrailContainer.innerHTML = '';
          }
          lastFootprintX = 0;
          lastFootprintY = 0;
          footprintDistance = 0;
          
          // Still update positions for smooth transition
          shipX += (targetX - shipX) * 0.15;
          shipY += (targetY - shipY) * 0.15;
          caravanX += (targetX - caravanX) * 0.15;
          caravanY += (targetY - caravanY) * 0.15;
        }
      } catch (error) {
        // Silently handle errors to prevent breaking the map
        console.warn('Cursor position update error:', error);
      }
      
      requestAnimationFrame(updateShipPosition);
    }

    // Track mouse movement
    document.addEventListener('mousemove', (e) => {
      targetX = e.clientX;
      targetY = e.clientY;
      
      // Only process if map is ready
      if (!mapReadyForShip || !map || !tokenOverlay) {
        return;
      }
      
      // Show ship when mouse is over the map area
      const worldWrapper = document.querySelector('.world-wrapper');
      if (worldWrapper && cursorShip) {
        try {
          const projection = tokenOverlay.getProjection();
          if (!projection) {
            return;
          }
          
          const rect = worldWrapper.getBoundingClientRect();
          const isOverMap = e.clientX >= rect.left && e.clientX <= rect.right &&
                            e.clientY >= rect.top && e.clientY <= rect.bottom;
          
          if (isOverMap) {
            // Convert mouse position to lat/lng
            const mapDiv = document.getElementById('world-map');
            if (!mapDiv) return;
            
            const mapRect = mapDiv.getBoundingClientRect();
            const x = e.clientX - mapRect.left;
            const y = e.clientY - mapRect.top;
            
            const point = new google.maps.Point(x, y);
            const latLng = projection.fromContainerPixelToLatLng(point);
            
            if (latLng) {
              const lat = latLng.lat();
              const lng = latLng.lng();
              shipIsOverWater = checkIfOverWater(lat, lng);
              isOverNorthAmerica = !shipIsOverWater && checkIfInNorthAmerica(lat, lng);
              
              if (!isMouseOverMap) {
                isMouseOverMap = true;
                // Initialize positions
                shipX = e.clientX;
                shipY = e.clientY;
                caravanX = e.clientX;
                caravanY = e.clientY;
                footprintX = e.clientX;
                footprintY = e.clientY;
                parkedX = shipX;
                parkedY = shipY;
              }
            }
          } else {
            if (isMouseOverMap) {
              isMouseOverMap = false;
              shipIsOverWater = false;
              isOverNorthAmerica = false;
              // Hide ship, caravan and clear footprints when leaving map
              if (cursorShip) {
                cursorShip.classList.remove('visible');
              }
              if (cursorCaravan) {
                cursorCaravan.classList.remove('visible');
              }
              if (footprintTrailContainer) {
                footprintTrailContainer.innerHTML = '';
              }
              lastFootprintX = 0;
              lastFootprintY = 0;
              footprintDistance = 0;
            }
          }
        } catch (error) {
          // Silently handle errors to prevent breaking the map
          console.warn('Ship tracking error:', error);
        }
      }
    });

    // Function to create a footprint at a position
    function createFootprint(x, y) {
      if (!footprintTrailContainer) return;
      
      const footprint = document.createElement('div');
      footprint.className = 'footprint';
      footprint.style.left = (x - 15) + 'px';
      footprint.style.top = (y - 15) + 'px';
      
      // Create bird footprint SVG (three-toed Y shape)
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', '30');
      svg.setAttribute('height', '30');
      svg.setAttribute('viewBox', '0 0 30 30');
      svg.setAttribute('class', 'footprint-svg');
      
      // Three-toed bird footprint (Y shape)
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M 15 25 L 15 18 L 10 12 L 15 10 L 20 12 L 15 18 Z');
      path.setAttribute('fill', '#2d2d2d');
      path.setAttribute('opacity', '0.7');
      
      svg.appendChild(path);
      footprint.appendChild(svg);
      footprintTrailContainer.appendChild(footprint);
      
      // Remove footprint after animation completes
      setTimeout(() => {
        if (footprint.parentNode) {
          footprint.parentNode.removeChild(footprint);
        }
      }, 3000);
    }

    // Hide ship/caravan/footprints when mouse leaves window
    document.addEventListener('mouseleave', () => {
      isMouseOverMap = false;
      shipIsOverWater = false;
      isOverNorthAmerica = false;
      if (cursorShip) {
        cursorShip.classList.remove('visible');
      }
      if (cursorCaravan) {
        cursorCaravan.classList.remove('visible');
      }
      if (footprintTrailContainer) {
        footprintTrailContainer.innerHTML = '';
      }
      lastFootprintX = 0;
      lastFootprintY = 0;
      footprintDistance = 0;
    });

    // Start ship/caravan position update loop
    if (cursorShip || cursorCaravan) {
      updateShipPosition();
    }

    // AI Search Functionality
    const OPENAI_API_KEY = 'YOUR_OPENAI_API_KEY'; // Replace with your API key or set via environment variable
    const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';

    const aiSearchInput = document.getElementById('aiSearchInput');
    const aiResponsePanel = document.getElementById('aiResponsePanel');
    const aiResponseContent = document.getElementById('aiResponseContent');
    const aiResponseClose = document.getElementById('aiResponseClose');

    // Function to show loading state
    function showAILoading() {
      aiResponseContent.innerHTML = '<div class="ai-response-loading">Thinking</div>';
      aiResponsePanel.classList.add('visible');
    }

    // Function to show error
    function showAIError(message) {
      aiResponseContent.innerHTML = `<div class="ai-response-error"><strong>Error:</strong> ${message}</div>`;
      aiResponsePanel.classList.add('visible');
    }

    // Function to show AI response
    function showAIResponse(text) {
      // Format the response with basic markdown-like formatting
      let formattedText = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
      
      aiResponseContent.innerHTML = `<div class="ai-response-content">${formattedText}</div>`;
      aiResponsePanel.classList.add('visible');
    }

    // Function to query AI
    async function queryAI(question) {
      if (!OPENAI_API_KEY || OPENAI_API_KEY === 'YOUR_OPENAI_API_KEY') {
        showAIError('Please configure your OpenAI API key in the JavaScript code. Get your key at <a href="https://platform.openai.com/api-keys" target="_blank">https://platform.openai.com/api-keys</a>');
        return;
      }

      showAILoading();

      try {
        const response = await fetch(OPENAI_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [
              {
                role: 'system',
                content: 'You are a helpful assistant for PAPO\'S, a snack company that offers unique flavors from around the world. Be friendly, informative, and enthusiastic about snacks and flavors. Keep responses concise and engaging.'
              },
              {
                role: 'user',
                content: question
              }
            ],
            max_tokens: 300,
            temperature: 0.7
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || `API error: ${response.status}`);
        }

        const data = await response.json();
        const aiMessage = data.choices[0]?.message?.content || 'Sorry, I couldn\'t generate a response.';
        showAIResponse(aiMessage);
      } catch (error) {
        console.error('AI query error:', error);
        showAIError(error.message || 'Failed to get response from AI. Please check your API key and try again.');
      }
    }

    // Event listeners
    if (aiSearchInput) {
      aiSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const question = aiSearchInput.value.trim();
          if (question) {
            queryAI(question);
            aiSearchInput.value = '';
          }
        }
      });
    }

    if (aiResponseClose) {
      aiResponseClose.addEventListener('click', () => {
        aiResponsePanel.classList.remove('visible');
      });
    }

    // Close panel when clicking outside
    if (aiResponsePanel) {
      aiResponsePanel.addEventListener('click', (e) => {
        if (e.target === aiResponsePanel) {
          aiResponsePanel.classList.remove('visible');
        }
      });
    }

    // Initialize Google Drive images when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateImagesToGoogleDrive);
    } else {
      // DOM is already loaded
      updateImagesToGoogleDrive();
    }
  </script>
</body>
</html>
